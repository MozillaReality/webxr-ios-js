!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";const e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class r{constructor(){this[t]={listeners:new Map}}addEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];i.push(r),this[t].listeners.set(e,i)}removeEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];for(let e=i.length;e>=0;e--)i[e]===r&&i.pop()}dispatchEvent(e,r){const i=this[t].listeners.get(e)||[],s=[];for(let e=0;e<i.length;e++)s[e]=i[e];for(let e of s)e(r);"function"==typeof this[`on${e}`]&&this[`on${e}`](r)}}const i=1e-6;let s="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function n(){let e=new s(16);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function a(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function o(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],p=t[11],m=t[12],f=t[13],_=t[14],g=t[15],v=r*o-i*a,b=r*h-s*a,w=r*l-n*a,y=i*h-s*o,x=i*l-n*o,E=s*l-n*h,S=c*f-d*m,R=c*_-u*m,M=c*g-p*m,A=d*_-u*f,T=d*g-p*f,I=u*g-p*_,P=v*I-b*T+w*A+y*M-x*R+E*S;return P?(P=1/P,e[0]=(o*I-h*T+l*A)*P,e[1]=(s*T-i*I-n*A)*P,e[2]=(f*E-_*x+g*y)*P,e[3]=(u*x-d*E-p*y)*P,e[4]=(h*M-a*I-l*R)*P,e[5]=(r*I-s*M+n*R)*P,e[6]=(_*w-m*E-g*b)*P,e[7]=(c*E-u*w+p*b)*P,e[8]=(a*T-o*M+l*S)*P,e[9]=(i*M-r*T-n*S)*P,e[10]=(m*x-f*w+g*v)*P,e[11]=(d*w-c*x-p*v)*P,e[12]=(o*R-a*A-h*S)*P,e[13]=(r*A-i*R+s*S)*P,e[14]=(f*b-m*y-_*v)*P,e[15]=(c*y-d*b+u*v)*P,e):null}function h(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],p=t[10],m=t[11],f=t[12],_=t[13],g=t[14],v=t[15],b=r[0],w=r[1],y=r[2],x=r[3];return e[0]=b*i+w*o+y*d+x*f,e[1]=b*s+w*h+y*u+x*_,e[2]=b*n+w*l+y*p+x*g,e[3]=b*a+w*c+y*m+x*v,b=r[4],w=r[5],y=r[6],x=r[7],e[4]=b*i+w*o+y*d+x*f,e[5]=b*s+w*h+y*u+x*_,e[6]=b*n+w*l+y*p+x*g,e[7]=b*a+w*c+y*m+x*v,b=r[8],w=r[9],y=r[10],x=r[11],e[8]=b*i+w*o+y*d+x*f,e[9]=b*s+w*h+y*u+x*_,e[10]=b*n+w*l+y*p+x*g,e[11]=b*a+w*c+y*m+x*v,b=r[12],w=r[13],y=r[14],x=r[15],e[12]=b*i+w*o+y*d+x*f,e[13]=b*s+w*h+y*u+x*_,e[14]=b*n+w*l+y*p+x*g,e[15]=b*a+w*c+y*m+x*v,e}function l(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=i+i,h=s+s,l=n+n,c=i*o,d=i*h,u=i*l,p=s*h,m=s*l,f=n*l,_=a*o,g=a*h,v=a*l;return e[0]=1-(p+f),e[1]=d+v,e[2]=u-g,e[3]=0,e[4]=d-v,e[5]=1-(c+f),e[6]=m+_,e[7]=0,e[8]=u+g,e[9]=m-_,e[10]=1-(c+p),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function c(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function d(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function u(){let e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function p(e){var t=new s(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function m(e,t,r){let i=new s(3);return i[0]=e,i[1]=t,i[2]=r,i}function f(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function _(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function g(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function v(e,t){let r=t[0],i=t[1],s=t[2],n=r*r+i*i+s*s;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function b(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function w(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}function y(e,t,r){let i=r[0],s=r[1],n=r[2],a=r[3],o=t[0],h=t[1],l=t[2],c=s*l-n*h,d=n*o-i*l,u=i*h-s*o,p=s*u-n*d,m=n*c-i*u,f=i*d-s*c,_=2*a;return c*=_,d*=_,u*=_,p*=2,m*=2,f*=2,e[0]=o+c+p,e[1]=h+d+m,e[2]=l+u+f,e}const x=function(e){let t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)};!function(){let e=u()}();!function(){let e=function(){let e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();function E(){let e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function S(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=r[0],h=r[1],l=r[2],c=r[3];return e[0]=i*c+a*o+s*l-n*h,e[1]=s*c+a*h+n*o-i*l,e[2]=n*c+a*l+i*h-s*o,e[3]=a*c-i*o-s*h-n*l,e}function R(e,t,r,s){let n,a,o,h,l,c=t[0],d=t[1],u=t[2],p=t[3],m=r[0],f=r[1],_=r[2],g=r[3];return(a=c*m+d*f+u*_+p*g)<0&&(a=-a,m=-m,f=-f,_=-_,g=-g),1-a>i?(n=Math.acos(a),o=Math.sin(n),h=Math.sin((1-s)*n)/o,l=Math.sin(s*n)/o):(h=1-s,l=s),e[0]=h*c+l*m,e[1]=h*d+l*f,e[2]=h*u+l*_,e[3]=h*p+l*g,e}function M(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n,o=a?1/a:0;return e[0]=-r*o,e[1]=-i*o,e[2]=-s*o,e[3]=n*o,e}const A=function(e){let t=new s(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},T=function(e,t,r,i){let n=new s(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n},I=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},P=function(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=i*a,e[2]=s*a,e[3]=n*a),e},O=(function(){let e=u(),t=m(1,0,0),r=m(0,1,0)}(),function(){let e=E(),t=E()}(),function(){let e=function(){let e=new s(9);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}()}(),Symbol("@@webxr-polyfill/XRRigidTransform"));class C{constructor(){if(this[O]={matrix:null,position:null,orientation:null,inverse:null},0===arguments.length)this[O].matrix=a(new Float32Array(16));else if(1===arguments.length)arguments[0]instanceof Float32Array?this[O].matrix=arguments[0]:(this[O].position=this._getPoint(arguments[0]),this[O].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else{if(2!==arguments.length)throw new Error("Too many arguments!");this[O].position=this._getPoint(arguments[0]),this[O].orientation=this._getPoint(arguments[1])}if(this[O].matrix){let e=u();c(e,this[O].matrix),this[O].position=DOMPointReadOnly.fromPoint({x:e[0],y:e[1],z:e[2]});let t=E();d(t,this[O].matrix),this[O].orientation=DOMPointReadOnly.fromPoint({x:t[0],y:t[1],z:t[2],w:t[3]})}else this[O].matrix=a(new Float32Array(16)),l(this[O].matrix,T(this[O].orientation.x,this[O].orientation.y,this[O].orientation.z,this[O].orientation.w),m(this[O].position.x,this[O].position.y,this[O].position.z))}_getPoint(e){return e instanceof DOMPointReadOnly?e:DOMPointReadOnly.fromPoint(e)}get matrix(){return this[O].matrix}get position(){return this[O].position}get orientation(){return this[O].orientation}get inverse(){if(null===this[O].inverse){let e=a(new Float32Array(16));o(e,this[O].matrix),this[O].inverse=new C(e),this[O].inverse[O].inverse=this}return this[O].inverse}}const F=Symbol("@@webxr-polyfill/XRSpace");class N{constructor(e=null,t=null){this[F]={specialType:e,inputSource:t,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[F].specialType}get _inputSource(){return this[F].inputSource}_ensurePoseUpdated(e,t){t!=this[F].lastFrameId&&(this[F].lastFrameId=t,this._onPoseUpdate(e))}_onPoseUpdate(e){"viewer"==this[F].specialType&&(this._baseMatrix=e.getBasePoseMatrix())}set _baseMatrix(e){this[F].baseMatrix=e,this[F].inverseBaseMatrix=null}get _baseMatrix(){return this[F].baseMatrix||this[F].inverseBaseMatrix&&(this[F].baseMatrix=new Float32Array(16),o(this[F].baseMatrix,this[F].inverseBaseMatrix)),this[F].baseMatrix}set _inverseBaseMatrix(e){this[F].inverseBaseMatrix=e,this[F].baseMatrix=null}get _inverseBaseMatrix(){return this[F].inverseBaseMatrix||this[F].baseMatrix&&(this[F].inverseBaseMatrix=new Float32Array(16),o(this[F].inverseBaseMatrix,this[F].baseMatrix)),this[F].inverseBaseMatrix}_getSpaceRelativeTransform(e){if(!this._inverseBaseMatrix||!e._baseMatrix)return null;let t=new Float32Array(16);return h(t,this._inverseBaseMatrix,e._baseMatrix),new C(t)}}const D=1.6,L=Symbol("@@webxr-polyfill/XRReferenceSpace"),V=["viewer","local","local-floor","bounded-floor","unbounded"];class k extends N{constructor(e,t=null){if(!V.includes(e))throw new Error(`XRReferenceSpaceType must be one of ${V}`);if(super(e),"bounded-floor"===e&&!t)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");(function(e){return"bounded-floor"===e||"local-floor"===e})(e)&&!t&&((t=a(new Float32Array(16)))[13]=D),this._inverseBaseMatrix=t||a(new Float32Array(16)),this[L]={type:e,transform:t,originOffset:a(new Float32Array(16))}}_transformBasePoseMatrix(e,t){h(e,this._inverseBaseMatrix,t)}_originOffsetMatrix(){return this[L].originOffset}_adjustForOriginOffset(e){let t=new Float32Array(16);o(t,this[L].originOffset),h(e,t,e)}_getSpaceRelativeTransform(e){let t=super._getSpaceRelativeTransform(e);return this._adjustForOriginOffset(t.matrix),new XRRigidTransform(t.matrix)}getOffsetReferenceSpace(e){let t=new k(this[L].type,this[L].transform,this[L].bounds);return h(t[L].originOffset,this[L].originOffset,e.matrix),t}}const X=Symbol("@@webxr-polyfill/XR"),G=["inline","immersive-vr","immersive-ar"],W={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},B="Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode\nor navigator.xr.requestSession('inline') prior to requesting an immersive\nsession. This is a limitation specific to the WebXR Polyfill and does not apply\nto native implementations of the API.";class U extends r{constructor(e){super(),this[X]={device:null,devicePromise:e,immersiveSession:null,inlineSessions:new Set},e.then(e=>{this[X].device=e})}async isSessionSupported(e){return this[X].device||await this[X].devicePromise,"inline"!=e?Promise.resolve(this[X].device.isSessionSupported(e)):Promise.resolve(!0)}async requestSession(e,t){if(!this[X].device){if("inline"!=e)throw new Error(B);await this[X].devicePromise}if(!G.includes(e))throw new TypeError(`The provided value '${e}' is not a valid enum value of type XRSessionMode`);const r=W[e],i=r.requiredFeatures.concat(t&&t.requiredFeatures?t.requiredFeatures:[]),s=r.optionalFeatures.concat(t&&t.optionalFeatures?t.optionalFeatures:[]),n=new Set;let a=!1;for(let e of i)this[X].device.isFeatureSupported(e)?n.add(e):(console.error(`The required feature '${e}' is not supported`),a=!0);if(a)throw new DOMException("Session does not support some required features","NotSupportedError");for(let e of s)this[X].device.isFeatureSupported(e)?n.add(e):console.log(`The optional feature '${e}' is not supported`);const o=await this[X].device.requestSession(e,n),h=new XRSession(this[X].device,e,o);"inline"==e?this[X].inlineSessions.add(h):this[X].immersiveSession=h;const l=()=>{"inline"==e?this[X].inlineSessions.delete(h):this[X].immersiveSession=null,h.removeEventListener("end",l)};return h.addEventListener("end",l),h}}let H;if("performance"in e==!1){let e=Date.now();H=(()=>Date.now()-e)}else H=(()=>performance.now());var q=H;const j=Symbol("@@webxr-polyfill/XRPose");class z{constructor(e,t){this[j]={transform:e,emulatedPosition:t}}get transform(){return this[j].transform}get emulatedPosition(){return this[j].emulatedPosition}}const Y=Symbol("@@webxr-polyfill/XRViewerPose");class K extends z{constructor(e,t,r=!1){super(e,r),this[Y]={views:t}}get views(){return this[Y].views}}const Q=Symbol("@@webxr-polyfill/XRViewport");class ${constructor(e){this[Q]={target:e}}get x(){return this[Q].target.x}get y(){return this[Q].target.y}get width(){return this[Q].target.width}get height(){return this[Q].target.height}}const Z=["left","right","none"],J=Symbol("@@webxr-polyfill/XRView");class ee{constructor(e,t,r,i){if(!Z.includes(r))throw new Error(`XREye must be one of: ${Z}`);const s=Object.create(null),n=new $(s);this[J]={device:e,eye:r,viewport:n,temp:s,sessionId:i,transform:t}}get eye(){return this[J].eye}get projectionMatrix(){return this[J].device.getProjectionMatrix(this.eye)}get transform(){return this[J].transform}_getViewport(e){if(this[J].device.getViewport(this[J].sessionId,this.eye,e,this[J].temp))return this[J].viewport}}const te=Symbol("@@webxr-polyfill/XRFrame"),re="XRFrame access outside the callback that produced it is invalid.",ie="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let se=0;class ne{constructor(e,t,r){this[te]={id:++se,active:!1,animationFrame:!1,device:e,session:t,sessionId:r}}get session(){return this[te].session}getViewerPose(e){if(!this[te].animationFrame)throw new DOMException(ie,"InvalidStateError");if(!this[te].active)throw new DOMException(re,"InvalidStateError");const t=this[te].device,r=this[te].session;r[be].viewerSpace._ensurePoseUpdated(t,this[te].id),e._ensurePoseUpdated(t,this[te].id);let i=e._getSpaceRelativeTransform(r[be].viewerSpace);const s=[];for(let i of r[be].viewSpaces){i._ensurePoseUpdated(t,this[te].id);let r=e._getSpaceRelativeTransform(i),n=new ee(t,r,i.eye,this[te].sessionId);s.push(n)}return new K(i,s,!1)}getPose(e,t){if(!this[te].active)throw new DOMException(re,"InvalidStateError");const r=this[te].device;if("target-ray"===e._specialType||"grip"===e._specialType)return r.getInputPose(e._inputSource,t,e._specialType);{e._ensurePoseUpdated(r,this[te].id),t._ensurePoseUpdated(r,this[te].id);let i=t._getSpaceRelativeTransform(e);return i?new XRPose(i,!1):null}}}const ae=Symbol("@@webxr-polyfill/XRRenderState"),oe=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class he{constructor(e={}){const t=Object.assign({},oe,e);this[ae]={config:t}}get depthNear(){return this[ae].config.depthNear}get depthFar(){return this[ae].config.depthFar}get inlineVerticalFieldOfView(){return this[ae].config.inlineVerticalFieldOfView}get baseLayer(){return this[ae].config.baseLayer}}const le=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),ce=Symbol("@@webxr-polyfill/xr-compatible"),de=Symbol("@@webxr-polyfill/XRWebGLLayer"),ue=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});const pe=Symbol("@@webxr-polyfill/XRInputSourceEvent");class me extends Event{constructor(e,t){super(e,t),this[pe]={frame:t.frame,inputSource:t.inputSource},Object.setPrototypeOf(this,me.prototype)}get frame(){return this[pe].frame}get inputSource(){return this[pe].inputSource}}const fe=Symbol("@@webxr-polyfill/XRSessionEvent");class _e extends Event{constructor(e,t){super(e,t),this[fe]={session:t.session},Object.setPrototypeOf(this,_e.prototype)}get session(){return this[fe].session}}const ge=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");class ve extends Event{constructor(e,t){super(e,t),this[ge]={session:t.session,added:t.added,removed:t.removed},Object.setPrototypeOf(this,ve.prototype)}get session(){return this[ge].session}get added(){return this[ge].added}get removed(){return this[ge].removed}}const be=Symbol("@@webxr-polyfill/XRSession");class we extends N{constructor(e){super(e)}get eye(){return this._specialType}_onPoseUpdate(e){this._inverseBaseMatrix=e.getBaseViewMatrix(this._specialType)}}class ye extends r{constructor(e,t,r){super();let i="inline"!=t,s=new he({inlineVerticalFieldOfView:i?null:.5*Math.PI});this[be]={device:e,mode:t,immersive:i,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:r,activeRenderState:s,pendingRenderState:null,viewerSpace:new k("viewer"),viewSpaces:[],currentInputSources:[]},i?this[be].viewSpaces.push(new we("left"),new we("right")):this[be].viewSpaces.push(new we("none")),this[be].onDeviceFrame=(()=>{if(this[be].ended||this[be].suspended)return;if(this[be].deviceFrameHandle=null,this[be].startDeviceFrameLoop(),null!==this[be].pendingRenderState&&(this[be].activeRenderState=new he(this[be].pendingRenderState),this[be].pendingRenderState=null,this[be].activeRenderState.baseLayer&&this[be].device.onBaseLayerSet(this[be].id,this[be].activeRenderState.baseLayer)),null===this[be].activeRenderState.baseLayer)return;const t=new ne(e,this,this[be].id),r=this[be].currentFrameCallbacks=this[be].frameCallbacks;this[be].frameCallbacks=[],t[te].active=!0,t[te].animationFrame=!0,this[be].device.onFrameStart(this[be].id,this[be].activeRenderState),this._checkInputSourcesChange();const i=q();for(let e=0;e<r.length;e++)try{r[e].cancelled||"function"!=typeof r[e].callback||r[e].callback(i,t)}catch(e){console.error(e)}this[be].currentFrameCallbacks=null,t[te].active=!1,this[be].device.onFrameEnd(this[be].id)}),this[be].startDeviceFrameLoop=(()=>{null===this[be].deviceFrameHandle&&(this[be].deviceFrameHandle=this[be].device.requestAnimationFrame(this[be].onDeviceFrame))}),this[be].stopDeviceFrameLoop=(()=>{const e=this[be].deviceFrameHandle;null!==e&&(this[be].device.cancelAnimationFrame(e),this[be].deviceFrameHandle=null)}),this[be].onPresentationEnd=(t=>{if(t!==this[be].id)return this[be].suspended=!1,this[be].startDeviceFrameLoop(),void this.dispatchEvent("focus",{session:this});this[be].ended=!0,this[be].stopDeviceFrameLoop(),e.removeEventListener("@@webxr-polyfill/vr-present-end",this[be].onPresentationEnd),e.removeEventListener("@@webxr-polyfill/vr-present-start",this[be].onPresentationStart),e.removeEventListener("@@webxr-polyfill/input-select-start",this[be].onSelectStart),e.removeEventListener("@@webxr-polyfill/input-select-end",this[be].onSelectEnd),this.dispatchEvent("end",new _e("end",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[be].onPresentationEnd),this[be].onPresentationStart=(e=>{e!==this[be].id&&(this[be].suspended=!0,this[be].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[be].onPresentationStart),this[be].onSelectStart=(e=>{e.sessionId===this[be].id&&this[be].dispatchInputSourceEvent("selectstart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-select-start",this[be].onSelectStart),this[be].onSelectEnd=(e=>{e.sessionId===this[be].id&&(this[be].dispatchInputSourceEvent("selectend",e.inputSource),this[be].dispatchInputSourceEvent("select",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[be].onSelectEnd),this[be].onSqueezeStart=(e=>{e.sessionId===this[be].id&&this[be].dispatchInputSourceEvent("squeezestart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-squeeze-start",this[be].onSqueezeStart),this[be].onSqueezeEnd=(e=>{e.sessionId===this[be].id&&(this[be].dispatchInputSourceEvent("squeezeend",e.inputSource),this[be].dispatchInputSourceEvent("squeeze",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-squeeze-end",this[be].onSqueezeEnd),this[be].dispatchInputSourceEvent=((t,r)=>{const i=new ne(e,this,this[be].id),s=new me(t,{frame:i,inputSource:r});i[te].active=!0,this.dispatchEvent(t,s),i[te].active=!1}),this[be].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[be].activeRenderState}get environmentBlendMode(){return this[be].device.environmentBlendMode||"opaque"}async requestReferenceSpace(e){if(this[be].ended)return;if(!V.includes(e))throw new TypeError(`XRReferenceSpaceType must be one of ${V}`);if(!this[be].device.doesSessionSupportReferenceSpace(this[be].id,e))throw new DOMException(`The ${e} reference space is not supported by this session.`,"NotSupportedError");if("viewer"===e)return this[be].viewerSpace;let t=await this[be].device.requestFrameOfReferenceTransform(e);if("bounded-floor"===e){if(!t)throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");if(!this[be].device.requestStageBounds())throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");throw new DOMException(`The WebXR polyfill does not support the ${e} reference space yet.`,"NotSupportedError")}return new k(e,t)}requestAnimationFrame(e){if(this[be].ended)return;const t=++this[be].frameHandle;return this[be].frameCallbacks.push({handle:t,callback:e,cancelled:!1}),t}cancelAnimationFrame(e){let t=this[be].frameCallbacks,r=t.findIndex(t=>t&&t.handle===e);r>-1&&(t[r].cancelled=!0,t.splice(r,1)),(t=this[be].currentFrameCallbacks)&&(r=t.findIndex(t=>t&&t.handle===e))>-1&&(t[r].cancelled=!0)}get inputSources(){return this[be].device.getInputSources()}async end(){if(!this[be].ended)return this[be].immersive&&(this[be].ended=!0,this[be].device.removeEventListener("@@webxr-polyfill/vr-present-start",this[be].onPresentationStart),this[be].device.removeEventListener("@@webxr-polyfill/vr-present-end",this[be].onPresentationEnd),this[be].device.removeEventListener("@@webxr-polyfill/input-select-start",this[be].onSelectStart),this[be].device.removeEventListener("@@webxr-polyfill/input-select-end",this[be].onSelectEnd),this.dispatchEvent("end",new _e("end",{session:this}))),this[be].stopDeviceFrameLoop(),this[be].device.endSession(this[be].id)}updateRenderState(e){if(this[be].ended){throw new Error("Can't call updateRenderState on an XRSession that has already ended.")}if(e.baseLayer&&e.baseLayer._session!==this){throw new Error("Called updateRenderState with a base layer that was created by a different session.")}if(null!==e.inlineVerticalFieldOfView&&void 0!==e.inlineVerticalFieldOfView){if(this[be].immersive){throw new Error("inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.")}e.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,e.inlineVerticalFieldOfView))}if(null===this[be].pendingRenderState){const e=this[be].activeRenderState;this[be].pendingRenderState={depthNear:e.depthNear,depthFar:e.depthFar,inlineVerticalFieldOfView:e.inlineVerticalFieldOfView,baseLayer:e.baseLayer}}Object.assign(this[be].pendingRenderState,e)}_checkInputSourcesChange(){const e=[],t=[],r=this.inputSources,i=this[be].currentInputSources;for(const t of r)i.includes(t)||e.push(t);for(const e of i)r.includes(e)||t.push(e);(e.length>0||t.length>0)&&this.dispatchEvent("inputsourceschange",new ve("inputsourceschange",{session:this,added:e,removed:t})),this[be].currentInputSources.length=0;for(const e of r)this[be].currentInputSources.push(e)}}const xe=Symbol("@@webxr-polyfill/XRInputSource");class Ee{constructor(e){this[xe]={impl:e,gripSpace:new N("grip",this),targetRaySpace:new N("target-ray",this)}}get handedness(){return this[xe].impl.handedness}get targetRayMode(){return this[xe].impl.targetRayMode}get gripSpace(){let e=this[xe].impl.targetRayMode;return"gaze"===e||"screen"===e?null:this[xe].gripSpace}get targetRaySpace(){return this[xe].targetRaySpace}get profiles(){return this[xe].impl.profiles}get gamepad(){return this[xe].impl.gamepad}}const Se=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");class Re extends Event{constructor(e,t){super(e,t),this[Se]={referenceSpace:t.referenceSpace,transform:t.transform||null},Object.setPrototypeOf(this,Re.prototype)}get referenceSpace(){return this[Se].referenceSpace}get transform(){return this[Se].transform}}var Me={XRSystem:U,XRSession:ye,XRSessionEvent:_e,XRFrame:ne,XRView:ee,XRViewport:$,XRViewerPose:K,XRWebGLLayer:class{constructor(e,t,r={}){const i=Object.assign({},ue,r);if(!(e instanceof ye))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[le]&&!0!==t[ce])throw new Error("InvalidStateError");const s=t.getParameter(t.FRAMEBUFFER_BINDING);this[de]={context:t,config:i,framebuffer:s,session:e}}get context(){return this[de].context}get antialias(){return this[de].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[de].framebuffer}get framebufferWidth(){return this[de].context.drawingBufferWidth}get framebufferHeight(){return this[de].context.drawingBufferHeight}get _session(){return this[de].session}getViewport(e){return e._getViewport(this)}static getNativeFramebufferScaleFactor(e){if(!e)throw new TypeError("getNativeFramebufferScaleFactor must be passed a session.");return e[be].ended?0:1}},XRSpace:N,XRReferenceSpace:k,XRReferenceSpaceEvent:Re,XRInputSource:Ee,XRInputSourceEvent:me,XRInputSourcesChangeEvent:ve,XRRenderState:he,XRRigidTransform:C,XRPose:z};const Ae=e=>"function"!=typeof e.prototype.makeXRCompatible&&(e.prototype.makeXRCompatible=function(){return this[ce]=!0,Promise.resolve()},!0),Te=e=>{const t=e.prototype.getContext;e.prototype.getContext=function(e,r){const i=t.call(this,e,r);return i&&(i[le]=!0,r&&"xrCompatible"in r&&(i[ce]=r.xrCompatible)),i}},Ie=async function(e,t){},Pe={global:e,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},Oe=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class Ce{constructor(e={}){this.config=Object.freeze(Object.assign({},Pe,e)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(e){if(!Oe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Oe}`);for(const t of Object.keys(Me))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=Me[t];Ae(e.WebGLRenderingContext)&&(Te(e.HTMLCanvasElement),e.OffscreenCanvas&&Te(e.OffscreenCanvas),e.WebGL2RenderingContext&&Ae(e.WebGL2RenderingContext),window.isSecureContext||console.warn("WebXR Polyfill Warning:\nThis page is not running in a secure context (https:// or localhost)!\nThis means that although the page may be able to use the WebXR Polyfill it will\nnot be able to use native WebXR implementations, and as such will not be able to\naccess dedicated VR or AR hardware, and will not be able to take advantage of\nany performance improvements a native WebXR implementation may offer. Please\nhost this content on a secure origin for the best user experience.\n"));this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let e=Ie(this.global,this.config);this.xr=new Me.XRSystem(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(e){if(!Oe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Oe}`);if(e.navigator.xr&&"supportsSession"in e.navigator.xr&&!("isSessionSupported"in e.navigator.xr)){let t=e.navigator.xr.supportsSession;e.navigator.xr.isSessionSupported=function(e){return t.call(this,e).then(()=>!0).catch(()=>!1)},e.navigator.xr.supportsSession=function(e){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),t.call(this,e)}}}}const Fe=1e-6;let Ne="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function De(){let e=new Ne(16);return Ne!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Le(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ve(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ke(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],p=t[11],m=t[12],f=t[13],_=t[14],g=t[15],v=r*o-i*a,b=r*h-s*a,w=r*l-n*a,y=i*h-s*o,x=i*l-n*o,E=s*l-n*h,S=c*f-d*m,R=c*_-u*m,M=c*g-p*m,A=d*_-u*f,T=d*g-p*f,I=u*g-p*_,P=v*I-b*T+w*A+y*M-x*R+E*S;return P?(P=1/P,e[0]=(o*I-h*T+l*A)*P,e[1]=(s*T-i*I-n*A)*P,e[2]=(f*E-_*x+g*y)*P,e[3]=(u*x-d*E-p*y)*P,e[4]=(h*M-a*I-l*R)*P,e[5]=(r*I-s*M+n*R)*P,e[6]=(_*w-m*E-g*b)*P,e[7]=(c*E-u*w+p*b)*P,e[8]=(a*T-o*M+l*S)*P,e[9]=(i*M-r*T-n*S)*P,e[10]=(m*x-f*w+g*v)*P,e[11]=(d*w-c*x-p*v)*P,e[12]=(o*R-a*A-h*S)*P,e[13]=(r*A-i*R+s*S)*P,e[14]=(f*b-m*y-_*v)*P,e[15]=(c*y-d*b+u*v)*P,e):null}function Xe(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],p=t[10],m=t[11],f=t[12],_=t[13],g=t[14],v=t[15],b=r[0],w=r[1],y=r[2],x=r[3];return e[0]=b*i+w*o+y*d+x*f,e[1]=b*s+w*h+y*u+x*_,e[2]=b*n+w*l+y*p+x*g,e[3]=b*a+w*c+y*m+x*v,b=r[4],w=r[5],y=r[6],x=r[7],e[4]=b*i+w*o+y*d+x*f,e[5]=b*s+w*h+y*u+x*_,e[6]=b*n+w*l+y*p+x*g,e[7]=b*a+w*c+y*m+x*v,b=r[8],w=r[9],y=r[10],x=r[11],e[8]=b*i+w*o+y*d+x*f,e[9]=b*s+w*h+y*u+x*_,e[10]=b*n+w*l+y*p+x*g,e[11]=b*a+w*c+y*m+x*v,b=r[12],w=r[13],y=r[14],x=r[15],e[12]=b*i+w*o+y*d+x*f,e[13]=b*s+w*h+y*u+x*_,e[14]=b*n+w*l+y*p+x*g,e[15]=b*a+w*c+y*m+x*v,e}function Ge(e,t,r){let i=Math.sin(r),s=Math.cos(r),n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],d=t[10],u=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*s+l*i,e[5]=a*s+c*i,e[6]=o*s+d*i,e[7]=h*s+u*i,e[8]=l*s-n*i,e[9]=c*s-a*i,e[10]=d*s-o*i,e[11]=u*s-h*i,e}function We(e,t,r){let i=Math.sin(r),s=Math.cos(r),n=t[0],a=t[1],o=t[2],h=t[3],l=t[8],c=t[9],d=t[10],u=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s-l*i,e[1]=a*s-c*i,e[2]=o*s-d*i,e[3]=h*s-u*i,e[8]=n*i+l*s,e[9]=a*i+c*s,e[10]=o*i+d*s,e[11]=h*i+u*s,e}function Be(e,t,r){let i,s,n,a=r[0],o=r[1],h=r[2],l=Math.sqrt(a*a+o*o+h*h);return l<Fe?null:(a*=l=1/l,o*=l,h*=l,i=Math.sin(t),n=1-(s=Math.cos(t)),e[0]=a*a*n+s,e[1]=o*a*n+h*i,e[2]=h*a*n-o*i,e[3]=0,e[4]=a*o*n-h*i,e[5]=o*o*n+s,e[6]=h*o*n+a*i,e[7]=0,e[8]=a*h*n+o*i,e[9]=o*h*n-a*i,e[10]=h*h*n+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function Ue(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=i+i,h=s+s,l=n+n,c=i*o,d=i*h,u=i*l,p=s*h,m=s*l,f=n*l,_=a*o,g=a*h,v=a*l;return e[0]=1-(p+f),e[1]=d+v,e[2]=u-g,e[3]=0,e[4]=d-v,e[5]=1-(c+f),e[6]=m+_,e[7]=0,e[8]=u+g,e[9]=m-_,e[10]=1-(c+p),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function He(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function qe(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function je(){let e=new Ne(3);return Ne!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ze(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e}function Ye(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[3]*i+r[7]*s+r[11]*n+r[15];return a=a||1,e[0]=(r[0]*i+r[4]*s+r[8]*n+r[12])/a,e[1]=(r[1]*i+r[5]*s+r[9]*n+r[13])/a,e[2]=(r[2]*i+r[6]*s+r[10]*n+r[14])/a,e}function Ke(e,t){let r=e[0],i=e[1],s=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(r-n)<=Fe*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-a)<=Fe*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=Fe*Math.max(1,Math.abs(s),Math.abs(o))}!function(){let e=je()}();class Qe extends r{constructor(e,t=null,r=0){super(),this._uid=t||Qe._generateUID(),this._transform=function(e){let t=new Ne(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}(e),this._timestamp=r,this._poseChanged=!0,this._deleted=!1,this._placeholder=!1}get deleted(){return this._deleted}set deleted(e){this._deleted=e}get placeholder(){return this._placeholder}set placeholder(e){this._placeholder=e}isMesh(){return!1}get timeStamp(){return this._timestamp}get changed(){return this._poseChanged}clearChanged(){this._poseChanged=!1}get modelMatrix(){return this._transform}updateModelMatrix(e,t){if(this._timestamp=t,!this._deleted&&!function(e,t){let r=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],d=e[9],u=e[10],p=e[11],m=e[12],f=e[13],_=e[14],g=e[15],v=t[0],b=t[1],w=t[2],y=t[3],x=t[4],E=t[5],S=t[6],R=t[7],M=t[8],A=t[9],T=t[10],I=t[11],P=t[12],O=t[13],C=t[14],F=t[15];return Math.abs(r-v)<=Fe*Math.max(1,Math.abs(r),Math.abs(v))&&Math.abs(i-b)<=Fe*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(s-w)<=Fe*Math.max(1,Math.abs(s),Math.abs(w))&&Math.abs(n-y)<=Fe*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(a-x)<=Fe*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(o-E)<=Fe*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(h-S)<=Fe*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(l-R)<=Fe*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(c-M)<=Fe*Math.max(1,Math.abs(c),Math.abs(M))&&Math.abs(d-A)<=Fe*Math.max(1,Math.abs(d),Math.abs(A))&&Math.abs(u-T)<=Fe*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(p-I)<=Fe*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(m-P)<=Fe*Math.max(1,Math.abs(m),Math.abs(P))&&Math.abs(f-O)<=Fe*Math.max(1,Math.abs(f),Math.abs(O))&&Math.abs(_-C)<=Fe*Math.max(1,Math.abs(_),Math.abs(C))&&Math.abs(g-F)<=Fe*Math.max(1,Math.abs(g),Math.abs(F))}(this._transform,e)){this._poseChanged=!0;for(var r=0;r<16;r++)this._transform[r]=e[r];try{this.dispatchEvent("update",{source:this})}catch(e){console.error("XRAnchor update event error",e)}}}notifyOfRemoval(){try{this.dispatchEvent("remove",{source:this})}catch(e){console.error("XRAnchor removed event error",e)}}get position(){return He(new Float32Array(3),this._poseMatrix)}get orientation(){return qe(new Float32Array(4),this._poseMatrix)}get uid(){return this._uid}static _generateUID(){return"anchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}}class $e extends Qe{constructor(e,t=null){super(t,null),this._anchor=e,this._timestamp=e.timeStamp,this._tempArray=new Float32Array(16),this._offsetMatrix=De(),t&&Le(this._offsetMatrix,t),Xe(this._transform,e.modelMatrix,this._offsetMatrix),this._handleAnchorUpdateListener=this._handleAnchorUpdate.bind(this),this._notifyOfRemovalListener=this.notifyOfRemoval.bind(this),this._handleReplaceAnchorListener=this._handleReplaceAnchor.bind(this),e.addEventListener("update",this._handleAnchorUpdateListener),e.addEventListener("removal",this._notifyOfRemovalListener),e.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleReplaceAnchor(e){this._anchor.removeEventListener("update",this._handleAnchorUpdateListener),this._anchor.removeEventListener("removal",this._notifyOfRemovalListener),this._anchor.removeEventListener("replaceAnchor",this._handleReplaceAnchorListener),this._anchor=e,this._anchor.addEventListener("update",this._handleAnchorUpdateListener),this._anchor.addEventListener("removal",this._notifyOfRemovalListener),this._anchor.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleAnchorUpdate(){Xe(this._tempArray,this._anchor.modelMatrix,this._offsetMatrix),this.updateModelMatrix(this._tempArray,Math.max(this._anchor.timeStamp,this._timestamp))}get modelMatrix(){return this._transform}clearChanged(){super.clearChanged()}get anchor(){return this._anchor}get offsetMatrix(){return this._offsetMatrix}set offsetMatrix(e){Le(this._offsetMatrix,e),this._handleAnchorUpdate()}}var Ze=!1;class Je extends Qe{static setUseGeomArrays(){Ze=!0}static useGeomArrays(){return Ze}constructor(e,t,r=null,i=0){super(e,r,i),this._useGeomArrays=Ze,this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._triangleIndices=[],this._textureCoordinates=[],this._vertexNormalsChanged=!0,this._vertexNormals=[],t&&(this._geometry=t,this._updateGeometry(this._geometry))}isMesh(){return!0}get changed(){return super.changed||this._vertexPositionsChanged||this._vertexNormalsChanged||this._triangleIndicesChanged||this._vertexCountChanged}clearChanged(){super.clearChanged(),this._vertexPositionsChanged=!1,this._vertexNormalsChanged=!1,this._triangleIndicesChanged=!1,this._vertexCountChanged=!1}get vertexCountChanged(){return this._vertexCountChanged}get vertexPositionsChanged(){return this._vertexPositionsChanged}get triangleIndicesChanged(){this._triangleIndicesChanged}get textureCoordinatesChanged(){this._textureCoordinatesChanged}get vertexNormalsChanged(){this._vertexNormalsChanged}get vertexPositions(){return this._vertexPositions}get vertexNormals(){return this._vertexNormals}get triangleIndices(){return this._triangleIndices}get textureCoordinates(){return this._textureCoordinates}get vertexCount(){return this._vertexPositions.length}get triangleCount(){return this._triangleIndices.length}get hasNormals(){return this._vertexNormals.length>0}get hasTextureCoordinates(){return this._textureCoordinates.length>0}_updateGeometry(e){this._geometry=e;let t=e;if(0==t.vertexCount)return void(this._vertexPositions.length>0&&(this._vertexPositionsChanged=!0,this._vertexNormalsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._vertexNormals=[],this.triangleIndices=[],this._textureCoordinates=[]));if(void 0===t.vertexCount)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertex count",t);let r=0;if(this._vertexPositions.length!=3*t.vertexCount){if(void 0===t.vertices)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertices",t);this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._vertexPositions=new Float32Array(3*t.vertexCount),t.textureCoordinates&&(this._textureCoordinatesChanged=!0,this._textureCoordinates=new Float32Array(2*t.vertexCount))}else if(this._useGeomArrays)this._vertexPositionsChanged=void 0!==t.vertices&&!Je.arrayFuzzyEquals(this._vertexPositions,t.vertices),this._textureCoordinatesChanged=void 0!==t.textureCoordinates&&!Je.arrayFuzzyEquals(this._textureCoordinates,t.textureCoordinates);else{if(this._vertexPositionsChanged=!1,t.vertices){r=0;for(var i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._vertexPositions[r++]-t.vertices[i].x)>Fe||Math.abs(this._vertexPositions[r++]-t.vertices[i].y)>Fe||Math.abs(this._vertexPositions[r++]-t.vertices[i].z)>Fe){this._vertexPositionsChanged=!0;break}}if(this._textureCoordinatesChanged=!1,t.textureCoordinates){r=0;for(i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>Fe||Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>Fe){this._textureCoordinatesChanged=!0;break}}}if(t.triangleCount?this._triangleIndices.length!=3*t.triangleCount?(this._triangleIndicesChanged=!0,this._triangleIndices=(Je.arrayMax(t.triangleIndices),new Uint32Array(3*t.triangleCount))):this._triangleIndicesChanged=t.triangleIndicies&&!Je.arrayEquals(this._triangleIndices,t.triangleIndices):this._triangleIndicesChanged=!1,this._vertexPositionsChanged)if(this._useGeomArrays)this._vertexPositions.set(t.vertices);else{r=0;for(let e of t.vertices)this._vertexPositions[r++]=e.x,this._vertexPositions[r++]=e.y,this._vertexPositions[r++]=e.z}if(this._textureCoordinatesChanged)if(r=0,this._useGeomArrays)this._textureCoordinates.set(t.textureCoordinates);else for(let e of t.textureCoordinates)this._textureCoordinates[r++]=e.x,this._textureCoordinates[r++]=e.y;this._triangleIndicesChanged&&this._triangleIndices.set(t.triangleIndices)}static arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,i=e.length;r<i;++r)e[r]>t&&(t=e[r]);return t}static arrayEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(e[r]!=t[r])return!1;return!0}static arrayFuzzyEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(Math.abs(e[r]-t[r])>Fe)return!1;return!0}}class et extends Je{constructor(e,t,r,i=null,s=0){super(e,t,i,s),this._blendShapes={},this._blendShapesChanged=!0,this._updateBlendShapes(r)}get changed(){return super.changed||this._blendShapesChanged}clearChanged(){super.clearChanged(),this._blendShapesChanged=!1}_updateBlendShapes(e){for(let i=0;i<tt.length;i++){let s=tt[i];var t=this._blendShapes[s];void 0===t&&(t=0);var r=e[i];Math.abs(t-r)>Fe&&(this._blendShapesChanged=!0,this._blendShapes[s]=r)}}updateFaceData(e,t,r,i){super.updateModelMatrix(e,i),void 0===t.vertexCount&&(t.vertexCount=t.vertices.length/(Je.useGeomArrays()?3:1)),this._updateGeometry(t),this._updateBlendShapes(r)}get blendShapes(){return this._blendShapes}}const tt=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"],rt=Symbol("@@webxr-polyfill/XRHitTestResult");class it{constructor(e,t){this[rt]={frame:e,transform:t}}getPose(e){const t=new N;return t._baseMatrix=Le(De(),this[rt].transform.matrix),this[rt].frame.getPose(t,e)}get _frame(){return this[rt].frame}}function st(){let e=new Ne(4);return Ne!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function nt(e,t,r,i,s){return e[0]=t,e[1]=r,e[2]=i,e[3]=s,e}function at(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3];return e[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*a,e[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*a,e[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*a,e[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*a,e}!function(){let e=st()}();const ot=Symbol("@@webxr-polyfill/XRRay");class ht{constructor(e,t){const r={x:0,y:0,z:0,w:1},i={x:0,y:0,z:-1,w:0};if(e&&e instanceof C){const t=e.matrix,s=nt(st(),r.x,r.y,r.z,r.w),n=nt(st(),i.x,i.y,i.z,i.w);at(s,s,t),at(n,n,t),r.x=s[0],r.y=s[1],r.z=s[2],r.w=s[3],_directionVec4.x=n[0],_directionVec4.y=n[1],_directionVec4.z=n[2],_directionVec4.w=n[3]}else e&&(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w),t&&(i.x=t.x,i.y=t.y,i.z=t.z,i.w=t.w);const s=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z)||1;i.x=i.x/s,i.y=i.y/s,i.z=i.z/s,this[ot]={origin:new DOMPointReadOnly(r.x,r.y,r.z,r.w),direction:new DOMPointReadOnly(i.x,i.y,i.z,i.w),matrix:null}}get origin(){return this[ot].origin}get direction(){return this[ot].direction}get matrix(){if(this[ot].matrix)return this[ot].matrix;const e=ze(je(),0,0,-1),t=ze(je(),this[ot].origin.x,this[ot].origin.y,this[ot].origin.z),r=ze(je(),this[ot].direction.x,this[ot].direction.y,this[ot].direction.z),i=function(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}(je(),r,e),s=(a=e,(n=r)[0]*a[0]+n[1]*a[1]+n[2]*a[2]);var n,a;const o=De();s>-1&&s<1?Be(o,Math.acos(s),i):-1===s&&Be(o,Math.acos(s),ze(je(),1,0,0));const h=(l=De(),c=t,l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=c[0],l[13]=c[1],l[14]=c[2],l[15]=1,l);var l,c;const d=Xe(De(),h,o);return this[ot].matrix=d,d}}const lt=Symbol("@@webxr-polyfill/XRHitTestSource");class ct{constructor(e,t){if(!t.space)throw new Error("XRHitTestSource requires space.");if("viewer"!==t.space._specialType)throw new Error("XRHitTestSource supports only viewer space for now.");if(t.entityTypes)for(const e of t.entityTypes)if("plane"!==e)throw new Error("XRHitTestSource does not support entityType"+e+" yet.");if(t.offsetRay&&(0!==t.offsetRay.origin.x||0!==t.offsetRay.origin.y||0!==t.offsetRay.origin.z||1!==t.offsetRay.origin.w))throw new Error("XRHitTestSource supports offsetRay.origin yet.");this[lt]={session:e,space:t.space,offsetRay:t.offsetRay||new ht,active:!0}}cancel(){this[lt].active=!1}get _space(){return this[lt].space}get _session(){return this[lt].session}get _offsetRay(){return this[lt].offsetRay}get _active(){return this[lt].active}}class dt extends Qe{}const ut=Symbol("@@webxr-polyfill/XRLightProbe");class pt{constructor(e={}){this[ut]={indirectIrradiance:e.indirectIrradiance}}get indirectIrradiance(){return this[ut].indirectIrradiance}get primaryLightDirection(){throw new Error("Not implemented")}get primaryLightIntensity(){throw new Error("Not implemented")}get sphericalHarmonicsCoefficients(){throw new Error("Not implemented")}get sphericalHarmonicsOrientation(){throw new Error("Not implemented")}}class mt extends Je{constructor(e,t,r,i,s,n=null,a=0){super(e,null,n,a),this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0,this._yAxis=function(e,t,r,i){let s=new Ne(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}(0,1,0,0),this._normal=st(),this._boundaryVerticesChanged=!0,this._boundaryVertices=[],this._geometry=s,this._updateGeometry(this._geometry)}get changed(){return super.changed||this._planeFeatureChanged}clearChanged(){super.clearChanged(),this._planeFeatureChanged=!1}updatePlaneData(e,t,r,i,s,n){super.updateModelMatrix(e,n),Ke(this._center,t)&&Ke(this._extent,r)&&!this._alignment||(this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0),this._updateGeometry(s)}get center(){return this._center}get extent(){return this._extent}get alignment(){return this._alignment}get boundaryVertices(){return this._boundaryVertices}get boundaryVerticesChanged(){return this._boundaryVerticesChanged}get boundaryVertexCount(){return this._boundaryVertices.length}_updateGeometry(e){super._updateGeometry(e);let t=e;const r=at(this._normal,this._yAxis,this._transform),i=r[0],s=r[1],n=r[2];let a=0;if(this._boundaryVertices.length!=3*t.boundaryVertexCount)this._boundaryVerticesChanged=!0,this._boundaryVertices=new Float32Array(3*t.vertexCount),this._vertexNormalsChanged=!0,this._vertexNormals=new Float32Array(3*t.vertexCount);else if(this._vertexNormalsChanged=Math.abs(this._vertexNormals[0]-i)>Fe||Math.abs(this._vertexNormals[1]-s)>Fe||Math.abs(this._vertexNormals[2]-n)>Fe,this._useGeomArrays)this._vertexPositionsChanged=!Je.arrayFuzzyEquals(this._boundaryVertices,t.boundaryVertices);else{this._boundaryVerticesChanged=!1,a=0;for(var o=0,h=t.vertexCount;o<h;o++)if(Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].x)>Fe||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].y)>Fe||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].z)>Fe){this._boundaryVerticesChanged=!0;break}}if(this._boundaryVerticesChanged)if(this._useGeomArrays)this._boundaryVertices.set(t.boundaryVertices);else{a=0;for(let e of t.boundaryVertices)this._boundaryVertices[a++]=e.x,this._boundaryVertices[a++]=e.y,this._boundaryVertices[a++]=e.z}if(this._vertexNormalsChanged){a=0;for(o=0;o<t.vertexCount;o++)this._vertexNormals[a++]=i,this._vertexNormals[a++]=s,this._vertexNormals[a++]=n}}}class ft{static decodeLength(e){return e.length/4*3}static decodeArrayBuffer(e,t){var r=e.length/4*3;return t&&t.byteLength==r||(t=new ArrayBuffer(r)),this.decode(e,t),t}static removePaddingChars(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e}static decode(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var r,i,s,n,a,o,h,l=parseInt(e.length/4*3,10),c=0,d=0;for(r=t?new Uint8Array(t):new Uint8Array(l),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<l;c+=3)i=this._keyStr.indexOf(e.charAt(d++))<<2|(a=this._keyStr.indexOf(e.charAt(d++)))>>4,s=(15&a)<<4|(o=this._keyStr.indexOf(e.charAt(d++)))>>2,n=(3&o)<<6|(h=this._keyStr.indexOf(e.charAt(d++))),r[c]=i,64!=o&&(r[c+1]=s),64!=h&&(r[c+2]=n);return r}static encode(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=e;e instanceof ArrayBuffer?i=new Uint8Array(arrayBuffer):e instanceof ImageData&&(i=e.data);for(var s,n=e.length,a=n%3,o=n-a,h=0;h<o;h+=3)t+=r[(16515072&(s=i[h]<<16|i[h+1]<<8|i[h+2]))>>18]+r[(258048&s)>>12]+r[(4032&s)>>6]+r[63&s];return 1==a?t+=r[(252&(s=i[o]))>>2]+r[(3&s)<<4]+"==":2==a&&(t+=r[(64512&(s=i[o]<<8|i[o+1]))>>10]+r[(1008&s)>>4]+r[(15&s)<<2]+"="),t}}ft._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var _t=[];class gt{constructor(e,t,r,i){this._buffers=e;for(var s=0;s<e.length;s++)if(e[s]._buffer=e[s].buffer,e[s].buffer=null,e[s]._abCache||"string"!=typeof e[s]._buffer){if(!e[s]._abCache&&e[s]._buffer instanceof ImageData){var n=e[s]._buffer.data;for(l=n.length,c=0;c<_t.length;c++)if(_t[c].byteLength==l){e[s]._abCache=_t[c],_t.splice(c,1);break}var a=e[s]._abCache?e[s]._abCache:new ArrayBuffer(l);e[s]._abCache=null;for(var o=new Uint8Array(a),h=0;h<l;h++)o[h]=n[h];e[s]._buffer=a}}else for(var l=ft.decodeLength(e[s]._buffer),c=0;c<_t.length;c++)if(_t[c].byteLength==l){e[s]._abCache=_t[c],_t.splice(c,1);break}this._pixelFormat=t,this._timestamp=r,this._camera=i}static createFromMessage(e){return new this(e.data.buffers,e.data.pixelFormat,e.data.timestamp,e.data.camera)}numBuffers(){this._buffers.length}buffer(e){if(e>=0&&e<this._buffers.length){var t=this._buffers[e];return t.buffer||("string"==typeof t._buffer?(t._buffer=ft.decodeArrayBuffer(t._buffer,t._abCache),t._abCache=null,t.buffer=new Uint8Array(t._buffer)):t._buffer instanceof ArrayBuffer?t.buffer=new Uint8Array(t._buffer):t._buffer instanceof ImageData&&(t.buffer=ImageData.data)),t}return null}get pixelFormat(){return this._pixelFormat}get timestamp(){return this._timestamp}get camera(){return this._camera}release(){for(var e=this._buffers,t=0;t<e.length;t++)e[t]._buffer instanceof ArrayBuffer&&e[t]._buffer.byteLength>0&&_t.push(e[t]._buffer),e[t]._abCache instanceof ArrayBuffer&&e[t]._abCache.byteLength>0&&_t.push(e[t]._abCache)}postMessageToWorker(e,t){var r=Object.assign({},t||{});r.buffers=this._buffers,r.timestamp=this._timestamp,r.pixelFormat=this._pixelFormat,r.camera=this._camera;for(var i=[],s=0;s<r.buffers.length;s++)r.buffers[s].buffer=r.buffers[s]._buffer,(r.buffers[s]._buffer instanceof ArrayBuffer||r.buffers[s]._buffer instanceof ImageData)&&i.push(r.buffers[s]._buffer),r.buffers[s]._buffer=null,r.buffers[s]._abCache instanceof ArrayBuffer&&i.push(r.buffers[s]._abCache);e.postMessage(r,i)}postReplyMessage(e){var t=Object.assign({},e);t.buffers=this._buffers,t.timestamp=this._timestamp,t.pixelFormat=this._pixelFormat,t.camera=this._camera;for(var r=[],i=0;i<t.buffers.length;i++)t.buffers[i].buffer=null,(t.buffers[i]._buffer instanceof ArrayBuffer||t.buffers[i]._buffer instanceof ImageData)&&(r.push(t.buffers[i]._buffer),t.buffers[i].buffer=t.buffers[i]._buffer),t.buffers[i]._buffer=null,t.buffers[i]._abCache instanceof ArrayBuffer&&r.push(t.buffers[i]._abCache);postMessage(t,r)}}gt.IMAGEFORMAT_RGBA32="RGBA32",gt.IMAGEFORMAT_BGRA32="BGRA32",gt.IMAGEFORMAT_RGB24="RGB24",gt.IMAGEFORMAT_BGR24="BGR24",gt.IMAGEFORMAT_GRAY8="GRAY8",gt.IMAGEFORMAT_YUV444P="YUV444P",gt.IMAGEFORMAT_YUV422P="YUV422P",gt.IMAGEFORMAT_YUV420P="YUV420P",gt.IMAGEFORMAT_YUV420SP_NV12="YUV420SP_NV12",gt.IMAGEFORMAT_YUV420SP_NV21="YUV420SP_NV21",gt.IMAGEFORMAT_HSV="HSV",gt.IMAGEFORMAT_Lab="Lab",gt.IMAGEFORMAT_DEPTH="DEPTH",gt.IMAGEFORMAT_NULL="",gt.IMAGEFORMAT=[gt.IMAGEFORMAT_RGBA32,gt.IMAGEFORMAT_BGRA32,gt.IMAGEFORMAT_RGB24,gt.IMAGEFORMAT_BGR24,gt.IMAGEFORMAT_GRAY8,gt.IMAGEFORMAT_YUV444P,gt.IMAGEFORMAT_YUV422P,gt.IMAGEFORMAT_YUV420P,gt.IMAGEFORMAT_YUV420SP_NV12,gt.IMAGEFORMAT_YUV420SP_NV21,gt.IMAGEFORMAT_HSV,gt.IMAGEFORMAT_Lab,gt.IMAGEFORMAT_DEPTH,gt.IMAGEFORMAT_NULL];var vt={XRAnchor:Qe,XRAnchorOffset:$e,XRFaceMesh:et,XRHitTestResult:it,XRHitTestSource:ct,XRTransientInputHitTestResult:class{constructor(){throw new Error("XRTransientInputHitTestResult is not supported yet.")}getPose(e){}},XRTransientInputHitTestSource:class{constructor(e){throw new Error("XRTransientInputHitTestSource is not supported yet.")}cancel(){}},XRImageAnchor:dt,XRLightProbe:pt,XRMesh:Je,XRPlaneMesh:mt,XRRay:ht,XRVideoFrame:gt};class bt extends r{constructor(e){super(),this.global=e,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}onBaseLayerSet(e,t){throw new Error("Not implemented")}isSessionSupported(e){throw new Error("Not implemented")}isFeatureSupported(e){throw new Error("Not implemented")}async requestSession(e,t){throw new Error("Not implemented")}requestAnimationFrame(e){throw new Error("Not implemented")}onFrameStart(e){throw new Error("Not implemented")}onFrameEnd(e){throw new Error("Not implemented")}doesSessionSupportReferenceSpace(e,t){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}async requestFrameOfReferenceTransform(e,t){}cancelAnimationFrame(e){throw new Error("Not implemented")}endSession(e){throw new Error("Not implemented")}getViewport(e,t,r,i){throw new Error("Not implemented")}getProjectionMatrix(e){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(e){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(e,t,r){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let wt={mapping:"xr-standard",profiles:["oculus-go","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[.11*Math.PI,0,0,1]}},yt={mapping:"xr-standard",displayProfiles:{"Oculus Quest":["oculus-touch-v2","oculus-touch","generic-trigger-squeeze-thumbstick"]},profiles:["oculus-touch","generic-trigger-squeeze-thumbstick"],axes:{length:4,0:null,1:null,2:0,3:1},buttons:{length:7,0:1,1:2,2:null,3:0,4:3,5:4,6:null},gripTransform:{position:[0,-.02,.04,1],orientation:[.11*Math.PI,0,0,1]}},xt={mapping:"xr-standard",profiles:["htc-vive","generic-trigger-squeeze-touchpad"],displayProfiles:{"HTC Vive":["htc-vive","generic-trigger-squeeze-touchpad"],"HTC Vive DVT":["htc-vive","generic-trigger-squeeze-touchpad"],"Valve Index":["valve-index","generic-trigger-squeeze-touchpad-thumbstick"]},buttons:{length:3,0:1,1:2,2:0},gripTransform:{position:[0,0,.05,1]},targetRayTransform:{orientation:[-.08*Math.PI,0,0,1]},userAgentOverrides:{Firefox:{axes:{invert:[1,3]}}}},Et={mapping:"xr-standard",profiles:["samsung-gearvr","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[.11*Math.PI,0,0,1]}},St={mapping:"xr-standard",profiles:["samsung-odyssey","microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[.11*Math.PI,0,0,1]}},Rt={mapping:"xr-standard",profiles:["microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[.11*Math.PI,0,0,1]}},Mt={"Daydream Controller":{mapping:"",profiles:["google-daydream","generic-trigger-touchpad"],buttons:{length:3,0:null,1:null,2:0}},"Gear VR Controller":Et,"HTC Vive Focus Controller":{mapping:"xr-standard",profiles:["htc-vive-focus","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0}},"Oculus Go Controller":wt,"Oculus Touch (Right)":yt,"Oculus Touch (Left)":yt,"OpenVR Gamepad":xt,"Spatial Controller (Spatial Interaction Source) 045E-065A":Rt,"Spatial Controller (Spatial Interaction Source) 045E-065D":St,"Windows Mixed Reality (Right)":Rt,"Windows Mixed Reality (Left)":Rt};const At=m(.155,-.465,-.15),Tt=m(-.155,-.465,-.15),It=m(0,0,-.25),Pt=m(0,0,.05),Ot=m(-.08,.14,.08),Ct=.4,Ft=.4,Nt=.61,Dt=.175,Lt=.12,Vt=.87,kt=180/Math.PI;class Xt{constructor(){this.hand="right",this.headElbowOffset=At,this.controllerQ=E(),this.lastControllerQ=E(),this.headQ=E(),this.headPos=u(),this.elbowPos=u(),this.wristPos=u(),this.time=null,this.lastTime=null,this.rootQ=E(),this.position=u()}setHandedness(e){this.hand!=e&&(this.hand=e,"left"==this.hand?this.headElbowOffset=Tt:this.headElbowOffset=At)}update(e,t){this.time=q(),e&&(I(this.lastControllerQ,this.controllerQ),I(this.controllerQ,e)),t&&(c(this.headPos,t),d(this.headQ,t));let r=this.getHeadYawOrientation_(),i=this.quatAngle_(this.lastControllerQ,this.controllerQ);i/((this.time-this.lastTime)/1e3)>Nt?R(this.rootQ,this.rootQ,r,Math.min(i/Dt,1)):I(this.rootQ,r);let s=m(0,0,-1);y(s,s,this.controllerQ);let n=b(s,[0,1,0]),a=this.clamp_((n-Lt)/Vt,0,1),o=A(this.rootQ);M(o,o),S(o,o,this.controllerQ);let h=this.elbowPos;f(h,this.headPos),_(h,h,this.headElbowOffset);let l=p(Ot);g(l,l,a),_(h,h,l);let u=this.quatAngle_(o,E())*kt,v=(1-Math.pow(u/180,4))*(Ct+(1-Ct)*a*Ft),w=E();R(w,w,o,v);let x=M(E(),w),T=A(o);S(T,T,x);let P=this.wristPos;f(P,Pt),y(P,P,w),_(P,P,It),y(P,P,T),_(P,P,h);let O=p(Ot);g(O,O,a),_(this.position,this.wristPos,O),y(this.position,this.position,this.rootQ),this.lastTime=this.time}getPosition(){return this.position}getHeadYawOrientation_(){let e=u();return function(e,t,r){function i(e,t,r){return e<t?t:e>r?r:e}var s=t[0]*t[0],n=t[1]*t[1],a=t[2]*t[2],o=t[3]*t[3];if("XYZ"===r)e[0]=Math.atan2(2*(t[0]*t[3]-t[1]*t[2]),o-s-n+a),e[1]=Math.asin(i(2*(t[0]*t[2]+t[1]*t[3]),-1,1)),e[2]=Math.atan2(2*(t[2]*t[3]-t[0]*t[1]),o+s-n-a);else if("YXZ"===r)e[0]=Math.asin(i(2*(t[0]*t[3]-t[1]*t[2]),-1,1)),e[1]=Math.atan2(2*(t[0]*t[2]+t[1]*t[3]),o-s-n+a),e[2]=Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),o-s+n-a);else if("ZXY"===r)e[0]=Math.asin(i(2*(t[0]*t[3]+t[1]*t[2]),-1,1)),e[1]=Math.atan2(2*(t[1]*t[3]-t[2]*t[0]),o-s-n+a),e[2]=Math.atan2(2*(t[2]*t[3]-t[0]*t[1]),o-s+n-a);else if("ZYX"===r)e[0]=Math.atan2(2*(t[0]*t[3]+t[2]*t[1]),o-s-n+a),e[1]=Math.asin(i(2*(t[1]*t[3]-t[0]*t[2]),-1,1)),e[2]=Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),o+s-n-a);else if("YZX"===r)e[0]=Math.atan2(2*(t[0]*t[3]-t[2]*t[1]),o-s+n-a),e[1]=Math.atan2(2*(t[1]*t[3]-t[0]*t[2]),o+s-n-a),e[2]=Math.asin(i(2*(t[0]*t[1]+t[2]*t[3]),-1,1));else{if("XZY"!==r)return void console.log("No order given for quaternion to euler conversion.");e[0]=Math.atan2(2*(t[0]*t[3]+t[1]*t[2]),o-s+n-a),e[1]=Math.atan2(2*(t[0]*t[2]+t[1]*t[3]),o+s-n-a),e[2]=Math.asin(i(2*(t[2]*t[3]-t[0]*t[1]),-1,1))}}(e,this.headQ,"YXZ"),function(e,t,r,i){let s=.5*Math.PI/180;t*=s,r*=s,i*=s;let n=Math.sin(t),a=Math.cos(t),o=Math.sin(r),h=Math.cos(r),l=Math.sin(i),c=Math.cos(i);return e[0]=n*h*c-a*o*l,e[1]=a*o*c+n*h*l,e[2]=a*h*l-n*o*c,e[3]=a*h*c+n*o*l,e}(E(),0,e[1]*kt,0)}clamp_(e,t,r){return Math.min(Math.max(e,t),r)}quatAngle_(e,t){let r=[0,0,-1],i=[0,0,-1];return y(r,r,e),y(i,i,t),function(e,t){let r=m(e[0],e[1],e[2]),i=m(t[0],t[1],t[2]);v(r,r),v(i,i);let s=b(r,i);return s>1?0:s<-1?Math.PI:Math.acos(s)}(r,i)}}const Gt=Symbol("@@webxr-polyfill/XRRemappedGamepad"),Wt={pressed:!1,touched:!1,value:0};Object.freeze(Wt);class Bt{constructor(e,t,r){if(r||(r={}),r.userAgentOverrides)for(let e in r.userAgentOverrides)if(navigator.userAgent.includes(e)){let t=r.userAgentOverrides[e];for(let e in t)e in r?Object.assign(r[e],t[e]):r[e]=t[e];break}let i=new Array(r.axes&&r.axes.length?r.axes.length:e.axes.length),s=new Array(r.buttons&&r.buttons.length?r.buttons.length:e.buttons.length),a=null;if(r.gripTransform){let e=r.gripTransform.orientation||[0,0,0,1];l(a=n(),P(e,e),r.gripTransform.position||[0,0,0])}let o=null;if(r.targetRayTransform){let e=r.targetRayTransform.orientation||[0,0,0,1];l(o=n(),P(e,e),r.targetRayTransform.position||[0,0,0])}let h=r.profiles;r.displayProfiles&&t.displayName in r.displayProfiles&&(h=r.displayProfiles[t.displayName]),this[Gt]={gamepad:e,map:r,profiles:h||[e.id],mapping:r.mapping||e.mapping,axes:i,buttons:s,gripTransform:a,targetRayTransform:o},this._update()}_update(){let e=this[Gt].gamepad,t=this[Gt].map,r=this[Gt].axes;for(let i=0;i<r.length;++i)t.axes&&i in t.axes?null===t.axes[i]?r[i]=0:r[i]=e.axes[t.axes[i]]:r[i]=e.axes[i];if(t.axes&&t.axes.invert)for(let e of t.axes.invert)e<r.length&&(r[e]*=-1);let i=this[Gt].buttons;for(let r=0;r<i.length;++r)t.buttons&&r in t.buttons?null===t.buttons[r]?i[r]=Wt:i[r]=e.buttons[t.buttons[r]]:i[r]=e.buttons[r]}get id(){return""}get _profiles(){return this[Gt].profiles}get index(){return-1}get connected(){return this[Gt].gamepad.connected}get timestamp(){return this[Gt].gamepad.timestamp}get mapping(){return this[Gt].mapping}get axes(){return this[Gt].axes}get buttons(){return this[Gt].buttons}get hapticActuators(){return this[Gt].gamepad.hapticActuators}}class Ut{constructor(e,t,r=0,i=-1){this.polyfill=e,this.display=t,this.nativeGamepad=null,this.gamepad=null,this.inputSource=new Ee(this),this.lastPosition=u(),this.emulatedPosition=!1,this.basePoseMatrix=n(),this.outputMatrix=n(),this.primaryButtonIndex=r,this.primaryActionPressed=!1,this.primarySqueezeButtonIndex=i,this.primarySqueezeActionPressed=!1,this.handedness="",this.targetRayMode="gaze",this.armModel=null}get profiles(){return this.gamepad?this.gamepad._profiles:[]}updateFromGamepad(e){this.nativeGamepad!==e&&(this.nativeGamepad=e,this.gamepad=e?new Bt(e,this.display,Mt[e.id]):null),this.handedness=""===e.hand?"none":e.hand,this.gamepad&&this.gamepad._update(),e.pose?(this.targetRayMode="tracked-pointer",this.emulatedPosition=!e.pose.hasPosition):""===e.hand&&(this.targetRayMode="gaze",this.emulatedPosition=!1)}updateBasePoseMatrix(){if(this.nativeGamepad&&this.nativeGamepad.pose){let e=this.nativeGamepad.pose,t=e.position,r=e.orientation;if(!t&&!r)return;t?(this.lastPosition[0]=t[0],this.lastPosition[1]=t[1],this.lastPosition[2]=t[2]):e.hasPosition?t=this.lastPosition:(this.armModel||(this.armModel=new Xt),this.armModel.setHandedness(this.nativeGamepad.hand),this.armModel.update(r,this.polyfill.getBasePoseMatrix()),t=this.armModel.getPosition()),l(this.basePoseMatrix,r,t)}else e=this.basePoseMatrix,t=this.polyfill.getBasePoseMatrix(),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15];var e,t;return this.basePoseMatrix}getXRPose(e,t){switch(this.updateBasePoseMatrix(),t){case"target-ray":e._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[Gt].targetRayTransform&&h(this.outputMatrix,this.outputMatrix,this.gamepad[Gt].targetRayTransform);break;case"grip":if(!this.nativeGamepad||!this.nativeGamepad.pose)return null;e._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[Gt].gripTransform&&h(this.outputMatrix,this.outputMatrix,this.gamepad[Gt].gripTransform);break;default:return null}return e._adjustForOriginOffset(this.outputMatrix),new XRPose(new XRRigidTransform(this.outputMatrix),this.emulatedPosition)}}let Ht=function(e,t,r=!0,i=!0){var s,n,a,o,h=0,l=function(){h=!1===r?0:Date.now(),s=null,o=e.apply(n,a),s||(n=a=null)},c=function(){var c=Date.now();h||!1!==r||(h=c);var d=t-(c-h);return n=this,a=arguments,d<=0||d>t?(s&&(clearTimeout(s),s=null),h=c,o=e.apply(n,a),s||(n=a=null)):s||!1===i||(s=setTimeout(l,d)),o};return c.cancel=function(){clearTimeout(s),h=0,s=n=a=null},c};Ht(function(...e){console.log(...e)},1e3);class qt extends r{constructor(){if(super(),!1===qt.HasARKit())throw new Error("ARKitWrapper will only work in Mozilla's ARDemo test app");if(void 0!==qt.GLOBAL_INSTANCE)throw new Error("ARKitWrapper is a singleton. Use ARKitWrapper.GetOrCreate() to get the global instance.");this._timestamp=0,this._lightProbe=null,this._deviceId=null,this._isWatching=!1,this._waitingForSessionStart=!1,this._isInitialized=!1,this._rawARData=null,this._rAF_callbacks=[],this._rAF_currentCallbacks=[],this._frameHandle=1,this._requestedPermissions={cameraAccess:!1,worldAccess:!1},this._currentPermissions={cameraAccess:!1,worldAccess:!1},this._worldSensingState={meshDetectionState:!1},this._worldInformation=null,this._projectionMatrix=new Float32Array(16),this._viewMatrix=new Float32Array(16),this._cameraTransform=new Float32Array(16),this._anchors=new Map,this._timeOffsets=[],this._timeOffset=0,this._timeOffsetComputed=!1,this._dataBeforeNext=0,this._worldMappingStatus=qt.WEB_AR_WORLDMAPPING_NOT_AVAILABLE,this._defaultOptions={location:!0,camera:!0,objects:!0,light_intensity:!0,computer_vision_data:!1};const e={arkitStartRecording:qt.RECORD_START_EVENT,arkitStopRecording:qt.RECORD_STOP_EVENT,arkitDidMoveBackground:qt.DID_MOVE_BACKGROUND_EVENT,arkitWillEnterForeground:qt.WILL_ENTER_FOREGROUND_EVENT,arkitInterrupted:qt.INTERRUPTED_EVENT,arkitInterruptionEnded:qt.INTERRUPTION_ENDED_EVENT,arkitShowDebug:qt.SHOW_DEBUG_EVENT,arkitWindowResize:qt.WINDOW_RESIZE_EVENT,onError:qt.ON_ERROR,arTrackingChanged:qt.AR_TRACKING_CHANGED};for(const t in e)window[t]=(r=>{r=r||null;try{this.dispatchEvent(e[t],new CustomEvent(e[t],{source:this,detail:r}))}catch(e){console.error(t+" callback error",e)}});window.onComputerVisionData=(e=>{this._onComputerVisionData(e)}),window.setNativeTime=(e=>{this._timeOffsets.push((performance||Date).now()-e.nativeTime),this._timeOffsetComputed=!0,this._timeOffset=0;for(let e=0;e<this._timeOffsets.length;e++)this._timeOffset+=this._timeOffsets[e];this._timeOffset=this._timeOffset/this._timeOffsets.length}),window.userGrantedComputerVisionData=(e=>{this._sessionCameraAccess|=e.granted}),window.userGrantedWorldSensingData=(e=>{this._sessionWorldAccess|=e.granted}),window.userStoppedAR=(e=>{this._handleStopped();try{this.dispatchEvent(qt.USER_STOPPED_AR,new CustomEvent(qt.USER_STOPPED_AR,{}))}catch(e){console.error("USER_STOPPED_AR event error",e)}})}static GetOrCreate(e=null){if(void 0===qt.GLOBAL_INSTANCE){const t=new qt;qt.GLOBAL_INSTANCE=t;const r={browser:!0,points:!0,focus:!1,rec:!0,rec_time:!0,mic:!1,build:!1,plane:!0,warnings:!0,anchors:!1,debug:!0,statistics:!1},i="object"==typeof(e=e&&"object"==typeof e?e:{}).ui?e.ui:{};e.ui=Object.assign(r,i),e.geometry_arrays=!0,Je.setUseGeomArrays(),console.log("----INIT"),t._initAR(e).then(e=>{t._deviceId=e,t._isInitialized=!0;try{t.dispatchEvent(qt.INIT_EVENT,new CustomEvent(qt.INIT_EVENT,{source:t}))}catch(e){console.error("INIT_EVENT event error",e)}})}return qt.GLOBAL_INSTANCE}static HasARKit(){return void 0!==window.webkit}get deviceId(){return this._deviceId}get hasSession(){return this._isWatching}get isInitialized(){return this._isInitialized}_sendMessage(e,t={},r=!0,i=!0){return new Promise((s,n)=>{if(r&&!this._isInitialized)return void n(new Error("ARKit is not initialized"));const a={};if(i){const t="arkitCallback_"+e+"_"+(new Date).getTime()+"_"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);window[t]=(e=>{delete window[t],s(e)}),a.callback=t}window.webkit.messageHandlers[e].postMessage(Object.assign({},t,a)),i||s()})}_initAR(e){return this._sendMessage("initAR",{options:e},!1)}_requestSession(e,t){return this._sendMessage("requestSession",{options:e,data_callback:t})}_hitTest(e,t,r){return this._sendMessage("hitTest",{x:e,y:t,type:r})}_addAnchor(e,t){return this._sendMessage("addAnchor",{uuid:e,transform:t})}_removeAnchors(e){return new Promise(t=>{window.webkit.messageHandlers.removeAnchors.postMessage(e),t()})}_createDetectionImage(e,t,r,i,s){return this._sendMessage("createImageAnchor",{uid:e,buffer:ft.encode(t),imageWidth:r,imageHeight:i,physicalWidth:s})}_destroyDetectionImage(e){return this._sendMessage("destroyImageAnchor",{uid:e})}_activateDetectionImage(e,t=!1){return this._sendMessage("activateDetectionImage",{uid:e,trackable:t})}_deactivateDetectionImage(e){return this._sendMessage("deactivateDetectionImage",{uid:e})}_setNumberOfTrackedImages(e){this._sendMessage("setNumberOfTrackedImages",{numberOfTrackedImages:"number"==typeof e?e:0},!0,!1)}_getWorldMap(){return this._sendMessage("getWorldMap")}_setWorldMap(e){return this._sendMessage("setWorldMap",{worldMap:e.worldMap})}_stop(){return this._sendMessage("stopAR")}_setUIOptions(e){return this._sendMessage("setUIOptions",e,!0,!1)}_onUpdate(){return window.webkit.messageHandlers.onUpdate.postMessage({})}_requestComputerVisionData(){return this._sendMessage("requestComputerVisionData",{},!0,!1)}_startSendingComputerVisionData(){return this._sendMessage("startSendingComputerVisionData",{},!0,!1)}_stopSendingComputerVisionData(){return this._sendMessage("stopSendingComputerVisionData",{},!0,!1)}_onData(e){if(this._rawARData=e,this._worldInformation=null,this._timestamp=this._adjustARKitTime(e.timestamp),this._lightProbe=new pt({indirectIrradiance:e.light_intensity/1e3}),Le(this._cameraTransform,e.camera_transform),Le(this._viewMatrix,e.camera_view),Le(this._projectionMatrix,e.projection_camera),this._worldMappingStatus=e.worldMappingStatus,e.newObjects.length)for(let t=0;t<e.newObjects.length;t++){const r=e.newObjects[t],i=this._anchors.get(r.uuid);i&&i.deleted&&(i.deleted=!1),this._createOrUpdateAnchorObject(r)}if(e.removedObjects.length)for(let t=0;t<e.removedObjects.length;t++){const r=e.removedObjects[t],i=this._anchors.get(r);i?(i.notifyOfRemoval(),this._anchors.delete(r)):console.error("app signalled removal of non-existant anchor/plane")}if(e.objects.length)for(let t=0;t<e.objects.length;t++){const r=e.objects[t];this._createOrUpdateAnchorObject(r)}try{this.dispatchEvent(qt.WATCH_EVENT,new CustomEvent(qt.WATCH_EVENT,{source:this,detail:this}))}catch(e){console.error("WATCH_EVENT event error",e)}this._rAF_callbacks.length>0&&this._do_rAF(),this._dataBeforeNext++}_onComputerVisionData(e){if(!e)return console.error("detail passed to _onComputerVisionData is null"),void this._requestComputerVisionData();if(!e.frame||!e.frame.buffers||e.frame.buffers.length<=0)return console.error("detail passed to _onComputerVisionData is bad, no buffers"),void this._requestComputerVisionData();e.camera.arCamera=!0;const t=e.camera.interfaceOrientation;switch(e.camera.viewMatrix=e.camera.inverse_viewMatrix,t){case 1:e.camera.cameraOrientation=-90;break;case 2:e.camera.cameraOrientation=90;break;case 3:e.camera.cameraOrientation=0;break;case 4:e.camera.cameraOrientation=180}switch(e.frame.pixelFormatType){case"kCVPixelFormatType_420YpCbCr8BiPlanarFullRange":e.frame.pixelFormat="YUV420P";break;default:e.frame.pixelFormat=e.frame.pixelFormatType}const r=new gt(e.frame.buffers,e.frame.pixelFormat,this._adjustARKitTime(e.frame.timestamp),e.camera);try{this.dispatchEvent(qt.COMPUTER_VISION_DATA,new CustomEvent(qt.COMPUTER_VISION_DATA,{source:this,detail:r}))}catch(e){console.error("COMPUTER_VISION_DATA event error",e)}}_do_rAF(){const e=this._rAF_callbacks;return this._rAF_currentCallbacks=this._rAF_currentCallbacks.concat(this._rAF_callbacks),this._rAF_callbacks=[],window.requestAnimationFrame((...t)=>{this.startingRender();for(let t=0;t<e.length;t++){let r=this._rAF_currentCallbacks,i=r.findIndex(r=>r&&r.handle===e[t].handle);i>-1&&r.splice(i,1);try{e[t].cancelled||"function"!=typeof e[t].callback||e[t].callback(...e[t].params)}catch(e){console.error(e)}}this.finishedRender()})}_createOrUpdateAnchorObject(e){if(e.plane_center){const t=this._anchors.get(e.uuid);if(!t||t.placeholder){const r=new mt(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.z],e.plane_alignment,e.geometry,e.uuid,this._timestamp);if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with plane"),this._anchors.delete(e.uuid)}this._anchors.set(e.uuid,r),e.object=r}else t&&(t.updatePlaneData(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.y],e.plane_alignment,e.geometry,this._timestamp),e.object=t)}else{const t=this._anchors.get(e.uuid);if(!t||t.placeholder){let r;switch(e.type){case qt.ANCHOR_TYPE_FACE:r=new et(e.transform,e.geometry,e.blendShapes,e.uuid,this._timestamp);break;case qt.ANCHOR_TYPE_ANCHOR:r=new Qe(e.transform,e.uuid,this._timestamp);break;case qt.ANCHOR_TYPE_IMAGE:r=new dt(e.transform,e.uuid,this._timestamp)}if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t||mesh,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with new anchor")}this._anchors.set(e.uuid,r),e.object=r}else{switch(e.type){case qt.ANCHOR_TYPE_FACE:t.updateFaceData(e.transform,e.geometry,e.blendShapes,this._timestamp);break;default:t.updateModelMatrix(e.transform,this._timestamp)}e.object=t}}}_adjustARKitTime(e){return this._timeOffsetComputed?e+this._timeOffset:(performance||Date).now()}get hasData(){return null!==this._rawARData}getData(e=null){return e?this._rawARData&&void 0!==this._rawARData[e]?this._rawARData[e]:null:this._rawARData}waitForInit(){return new Promise((e,t)=>{if(this._isInitialized)return void e();const r=()=>{this.removeEventListener(qt.INIT_EVENT,r,!1),e()};this.addEventListener(qt.INIT_EVENT,r,!1)})}pickBestHit(e){if(0===e.length)return null;const t=e.filter(e=>e.type!=qt.HIT_TEST_TYPE_FEATURE_POINT),r=t.filter(e=>e.type==qt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT),i=t.filter(e=>e.type==qt.HIT_TEST_TYPE_EXISTING_PLANE);return r.length?(r=r.sort((e,t)=>e.distance-t.distance),r[0]):i.length?(i=i.sort((e,t)=>e.distance-t.distance),i[0]):t.length?(t=t.sort((e,t)=>e.distance-t.distance),t[0]):e[0]}createAnchorFromHit(e){return new Promise((t,r)=>{if(e.anchor_transform){let r=this._anchors.get(e.uuid);r?r.placeholder&&r.updateModelMatrix(e.anchor_transform,this._timestamp):(r=new Qe(e.anchor_transform,e.uuid,this._timestamp),console.log("created dummy anchor from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(new $e(r,e.local_transform))}else{let r=this._anchors.get(e.uuid);r?(r.placeholder=!1,r.deleted=!1,console.log("hit test resulted in a hit on an existing anchor, without an offset")):(r=new Qe(e.world_transform,e.uuid),console.log("created dummy anchor (not a plane) from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(r)}})}requestAnimationFrame(e,...t){const r=++this._frameHandle;return this._rAF_callbacks.push({handle:r,callback:e,params:t,cancelled:!1}),(!this._isWatching||this._dataBeforeNext>0)&&this._do_rAF(),r}cancelAnimationFrame(e){let t=this._rAF_callbacks,r=t.findIndex(t=>t&&t.handle===e);r>-1&&(t[r].cancelled=!0,t.splice(r,1)),(t=this._rAF_currentCallbacks)&&(r=t.findIndex(t=>t&&t.handle===e))>-1&&(t[r].cancelled=!0)}startingRender(){this._dataBeforeNext}finishedRender(){this._dataBeforeNext=0,this._anchors.forEach(e=>{e.clearChanged()}),this._onUpdate()}watch(e=null){return new Promise((t,r)=>{if(!this._isInitialized)return void r("ARKitWrapper hasn't been initialized yet");if(this._waitingForSessionStart)return void r("ARKitWrapper startSession called, waiting to finish");if(this._isWatching)return void t({cameraAccess:this._sessionCameraAccess,worldAccess:this._sessionWorldAccess,webXRAccess:!0});this._waitingForSessionStart=!0;let i=Object.assign({},this._defaultOptions);null!==e&&(i=Object.assign(i,e)),this._requestedPermissions.cameraAccess=i.videoFrames,this._requestedPermissions.worldAccess=i.worldSensing,i.videoFrames&&(delete i.videoFrames,i.computer_vision_data=!0),console.log("----WATCH");void 0===window.arkitCallbackOnData&&(window.arkitCallbackOnData=(e=>{this._onData(e)})),this._requestSession(i,"arkitCallbackOnData").then(e=>{e.webXRAccess?(this._waitingForSessionStart=!1,this._isWatching=!0,this._currentPermissions.cameraAccess=e.cameraAccess,this._currentPermissions.worldAccess=e.worldAccess,t(e)):r(new Error("user did not give permission to start a webxr session"))})})}stop(){return new Promise((e,t)=>{this._isWatching?(console.log("----STOP"),this._stop().then(t=>{this._handleStopped(),e(t)})):e()})}_handleStopped(){this._isWatching=!1,this._rAF_callbacks.length>0&&this._do_rAF()}hitTest(e,t,r=qt.HIT_TEST_TYPE_ALL){return this._hitTest(e,t,r)}createAnchor(e){return new Promise((t,r)=>{const i=new Qe(e,null,this._timestamp);this._addAnchor(i.uid,e).then(e=>{if(e.error)return void r(e.error);const s=this._anchors.get(e.uuid);s?(s.placeholder=!1,s.deleted=!1,s.updateModelMatrix(e.transform,this._timestamp),t(s)):(this._anchors.set(e.uuid,i),t(i))}).catch((...e)=>{console.error("could not create anchor",...e),r()})})}removeAnchor(e){let t=this._anchors.get(e.uid);t.placeholder?this._anchors.delete(e.uid):(t&&(t.deleted=!0),!e instanceof $e&&this._removeAnchors([e.uid]))}createDetectionImage(e,t,r,i,s){return new Promise((n,a)=>{this._createDetectionImage(e,t,r,i,s).then(e=>{e.error?a(e.error):e.created?n():a(null)}).catch((...e)=>{console.error("could not create image",...e),a()})})}destroyDetectionImage(e){return new Promise((t,r)=>{this._destroyDetectionImage(e).then(e=>{e.error?r(e.error):t()}).catch((...e)=>{console.error("could not destroy image",...e),r()})})}activateDetectionImage(e,t=!1){return new Promise((r,i)=>{const s=this._anchors.get(e);!s||s.deleted?this._activateDetectionImage(e,t).then(e=>{e.error&&(i(e.error),i()),e.activated?(this._createOrUpdateAnchorObject(e.imageAnchor),e.imageAnchor.object.deleted=!1,r(e.imageAnchor.object)):i(null)}).catch((...e)=>{console.error("could not activate image",...e),i()}):r(s)})}deactivateDetectionImage(e){return new Promise((t,r)=>{this._deactivateDetectionImage(e).then(i=>{i.error&&r(i.error);const s=this._anchors.get(e);s&&(console.warn("anchor for image target '"+e+"' still exists after deactivation"),this.removeAnchor(s)),t()}).catch((...e)=>{console.error("could not activate image",...e),r()})})}setNumberOfTrackedImages(e){return this._setNumberOfTrackedImages(e)}getWorldMap(){return new Promise((e,t)=>{this._getWorldMap().then(r=>{if(!0!==r.saved)return null!==r.error?void t(r.error):void t(null);e(r.worldMap)}).catch((...e)=>{console.error("could not get world map",...e),t()})})}setWorldMap(e){return this._setWorldMap(e)}getLightProbe(){return new Promise((e,t)=>{this._lightProbe?e(this._lightProbe):t(new Error("Not populated yet"))})}setUIOptions(e){return this._setUIOptions(e)}updateWorldSensingState(e){return e.hasOwnProperty("meshDetectionState")&&this._currentPermissions.worldAccess?this._worldSensingState.meshDetectionState=e.meshDetectionState.enabled||!1:this._worldSensingState.meshDetectionState=!1,this._worldSensingState}getWorldInformation(){if(this._worldInformation)return this._worldInformation;let e={};return this._worldSensingState.meshDetectionState&&(e.meshes=[],this._anchors.forEach(t=>{!t.isMesh()||t.deleted||t.placeholder||e.meshes.push(t)})),this._worldInformation=e,e}}qt.INIT_EVENT="arkit-init",qt.WATCH_EVENT="arkit-watch",qt.RECORD_START_EVENT="arkit-record-start",qt.RECORD_STOP_EVENT="arkit-record-stop",qt.DID_MOVE_BACKGROUND_EVENT="arkit-did-move-background",qt.WILL_ENTER_FOREGROUND_EVENT="arkit-will-enter-foreground",qt.INTERRUPTED_EVENT="arkit-interrupted",qt.INTERRUPTION_ENDED_EVENT="arkit-interruption-ended",qt.SHOW_DEBUG_EVENT="arkit-show-debug",qt.WINDOW_RESIZE_EVENT="arkit-window-resize",qt.ON_ERROR="on-error",qt.USER_STOPPED_AR="user-stopped-ar",qt.AR_TRACKING_CHANGED="ar_tracking_changed",qt.COMPUTER_VISION_DATA="cv_data",qt.USER_GRANTED_COMPUTER_VISION_DATA="user-granted-cv-data",qt.USER_GRANTED_WORLD_SENSING_DATA="user-granted-world-sensing-data",qt.ORIENTATION_UP=1,qt.ORIENTATION_UP_MIRRORED=2,qt.ORIENTATION_DOWN=3,qt.ORIENTATION_DOWN_MIRRORED=4,qt.ORIENTATION_LEFT_MIRRORED=5,qt.ORIENTATION_RIGHT=6,qt.ORIENTATION_RIGHT_MIRRORED=7,qt.ORIENTATION_LEFT=8,qt.WEB_AR_WORLDMAPPING_NOT_AVAILABLE="ar_worldmapping_not_available",qt.WEB_AR_WORLDMAPPING_LIMITED="ar_worldmapping_limited",qt.WEB_AR_WORLDMAPPING_EXTENDING="ar_worldmapping_extending",qt.WEB_AR_WORLDMAPPING_MAPPED="ar_worldmapping_mapped",qt.HIT_TEST_TYPE_FEATURE_POINT=1,qt.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE=2,qt.HIT_TEST_TYPE_ESTIMATED_VERTICAL_PLANE=4,qt.HIT_TEST_TYPE_EXISTING_PLANE=8,qt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT=16,qt.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY=32,qt.HIT_TEST_TYPE_ALL=qt.HIT_TEST_TYPE_FEATURE_POINT|qt.HIT_TEST_TYPE_EXISTING_PLANE|qt.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE|qt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,qt.HIT_TEST_TYPE_EXISTING_PLANES=qt.HIT_TEST_TYPE_EXISTING_PLANE|qt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,qt.ANCHOR_TYPE_PLANE="plane",qt.ANCHOR_TYPE_FACE="face",qt.ANCHOR_TYPE_ANCHOR="anchor",qt.ANCHOR_TYPE_IMAGE="image";class jt{constructor(e){this._subscribed=!1,this._arKitWrapper=e,this.subscribe()}subscribe(){this._subscribed||(this._subscribed=!0,this._arKitWrapper.addEventListener(qt.INIT_EVENT,this.handleARKitInit.bind(this)),this._arKitWrapper.addEventListener(qt.WATCH_EVENT,this.handleARKitUpdate.bind(this)),this._arKitWrapper.addEventListener(qt.WINDOW_RESIZE_EVENT,this.handleARKitWindowResize.bind(this)),this._arKitWrapper.addEventListener(qt.ON_ERROR,this.handleOnError.bind(this)),this._arKitWrapper.addEventListener(qt.AR_TRACKING_CHANGED,this.handleArTrackingChanged.bind(this)),this._arKitWrapper.addEventListener(qt.COMPUTER_VISION_DATA,this.handleComputerVisionData.bind(this)),this._arKitWrapper.addEventListener(qt.USER_STOPPED_AR,this.handleUserStoppedAR.bind(this)))}handleARKitInit(){}handleARKitUpdate(){}handleARKitWindowResize(){}handleOnError(){}handleArTrackingChanged(){}handleComputerVisionData(){}handleUserStoppedAR(){}}class zt extends bt{constructor(e){super(e),this._throttledLogPose=Ht(this.logPose,1e3),this._sessions=new Map,this._activeSession=null,this._frameSession=null,this._wrapperDiv=document.createElement("div"),this._wrapperDiv.setAttribute("class","arkit-device-wrapper");const t=()=>{document.body.insertBefore(this._wrapperDiv,document.body.firstChild||null)};document.body?t():document.addEventListener("DOMContentLoaded",t),this._headModelMatrix=De(),this._headModelMatrixInverse=De(),this._projectionMatrix=De(),this._deviceProjectionMatrix=De(),this._eyeLevelMatrix=Ve(De()),this._stageMatrix=Ve(De()),this._stageMatrix[13]=1.3,this._identityMatrix=Ve(De()),this._baseFrameSet=!1,this._frameOfRefRequestsWaiting=[],this._depthNear=.1,this._depthFar=1e3;try{this._arKitWrapper=qt.GetOrCreate(),this._arWatcher=new $t(this._arKitWrapper,this)}catch(e){console.error("Error initializing the ARKit wrapper",e),this._arKitWrapper=null,this._arWatcher=null}this._hitTestSources=[],this._hitTestResults=new Map,this._hitTestResultsForNextFrame=new Map,this._domOverlayRoot=null,this._topMostDomElement=null,this._activeXRSession=null,this._gamepads=[],this._gamepadInputSources=[],this._touches=[];this._gamepads.push(Yt("","right",1,!0)),this._gamepadInputSources.push(new Ut(this,{},0)),this._gamepadInputSources[0]._active=!1,this._touches.push({x:-1,y:-1});const r=(e,t)=>{if(!this._domOverlayRoot)return null;const r=document.elementsFromPoint(e,t);for(const e of r)if(this._domOverlayRoot.contains(e))return e;return null};document.addEventListener("touchstart",e=>{if(!e.touches||0==e.touches.length)return;const t=e.touches[0],i=t.clientX,s=t.clientY;this._topMostDomElement=r(i,s),this._touches[0].x=i,this._touches[0].y=s;const n=this._gamepads[0].buttons[0];n.pressed=!0,n.value=1}),document.addEventListener("touchmove",e=>{if(!e.touches||0==e.touches.length)return;const t=e.touches[0],i=t.clientX,s=t.clientY;this._topMostDomElement=r(i,s),this._touches[0].x=i,this._touches[0].y=s}),document.addEventListener("touchend",e=>{const t=this._touches[0].x,i=this._touches[0].y;this._topMostDomElement=r(t,i);const s=this._gamepads[0].buttons[0];s.pressed=!1,s.value=0,this._touches[0].x=-1,this._touches[0].y=-1})}static initStyles(){const e=()=>{const e=document.createElement("style");document.head.appendChild(e);const t=e.sheet;t.insertRule(".arkit-device-wrapper { z-index: -1; display: none; }",0),t.insertRule(".arkit-device-wrapper, .xr-canvas { background-color: transparent; position: absolute; top: 0; left: 0; bottom: 0; right: 0; }",0),t.insertRule(".arkit-device-wrapper, .arkit-device-wrapper canvas { width: 100%; height: 100%; padding: 0; margin: 0; -webkit-user-select: none; user-select: none; }",0)};document.body?e():window.addEventListener("DOMContentLoaded",e)}logPose(){console.log("pose",He(new Float32Array(3),this._headModelMatrix),qe(new Float32Array(4),this._headModelMatrix))}addHitTestSource(e){this._hitTestSources.includes(e)||this._hitTestSources.push(e)}_runHitTest(){this._hitTestResults.clear();let e=0;for(let t=0;t<this._hitTestSources.length;t++){const r=this._hitTestSources[t];r._active&&(r._session[be].ended?r.cancel():(this._hitTestSources[e++]=r,this._hitTestResultsForNextFrame.has(r)&&this._hitTestResults.set(r,this._hitTestResultsForNextFrame.get(r))))}if(this._hitTestSources.length=e,this._hitTestResultsForNextFrame.clear(),this._arKitWrapper)for(const e of this._hitTestSources){const t=je();t[0]=e._offsetRay.direction.x,t[1]=e._offsetRay.direction.y,t[2]=e._offsetRay.direction.z,Ye(t,t,this._arKitWrapper._projectionMatrix);const r=.5*(t[0]+1),i=.5*(1-t[1]);this._arKitWrapper.hitTest(r,i,qt.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY).then(t=>{this._hitTestResultsForNextFrame.has(e)||this._hitTestResultsForNextFrame.set(e,[]);const r=this._hitTestResultsForNextFrame.get(e);for(const e of t)r.push(new XRRigidTransform(new Float32Array(e.world_transform)))})}else console.error("Hit test requires ARKitWrapper.")}getHitTestResults(e){return this._hitTestResults.has(e)?this._hitTestResults.get(e):[]}setDomOverlayRoot(e){this._domOverlayRoot=e}setActiveXRSession(e){this._activeXRSession=e}_shouldSuppressSelectEvents(){if(this._topMostDomElement&&this._topMostDomElement.dispatchEvent){const e=new _e("beforexrselect",{session:this._activeXRSession,cancelable:!0});if(this._topMostDomElement.dispatchEvent(e),e.defaultPrevented)return!0}return!1}setProjectionMatrix(e){Le(this._deviceProjectionMatrix,e)}setBaseViewMatrix(e){if(Le(this._headModelMatrixInverse,e),ke(this._headModelMatrix,this._headModelMatrixInverse),!this._baseFrameSet){this._baseFrameSet=!0;for(let e=0;e<this._frameOfRefRequestsWaiting.length;e++){const t=this._frameOfRefRequestsWaiting[e];try{t()}catch(e){console.error("finalization of reference frame requests failed: ",e)}}this._frameOfRefRequestsWaiting.length=0}}get depthNear(){return this._depthNear}set depthNear(e){this._depthNear=e}get depthFar(){return this._depthFar}set depthFar(e){this._depthFar=e}isSessionSupported(e){return"immersive-ar"===e||"inline"===e}isFeatureSupported(e){switch(e){case"viewer":case"local":case"local-floor":return!0;case"bounded":case"unbounded":return!1;case"worldSensing":case"computerVision":case"alignEUS":case"hit-test":case"dom-overlay":return!0;default:return!1}}doesSessionSupportReferenceSpace(e,t){const r=this._sessions.get(e);if(r.ended)return!1;if(!r.enabledFeatures.has(t))return!1;switch(t){case"viewer":case"local":case"local-floor":return!0;case"bounded":case"unbounded":default:return!1}}async requestSession(e,t){if(!this.isSessionSupported(e))return console.error("Invalid session mode",e),Promise.reject();if("inline"===e){const r=new Qt(e,t);return this._sessions.set(r.id,r),Promise.resolve(r.id)}if(!this._arKitWrapper)return console.error("Session requested without an ARKitWrapper"),Promise.reject();if(null!==this._activeSession)return console.error("Tried to start a second active session"),Promise.reject();const r={};return t.has("worldSensing")&&(r.worldSensing=!0),t.has("computerVision")&&(r.videoFrames=!0),t.has("alignEUS")&&(r.alignEUS=!0),await this._arKitWrapper.waitForInit().then(()=>{}).catch((...e)=>(console.error("app failed to initialize: ",...e),Promise.reject())),await this._arKitWrapper.watch(r).then(r=>{const i=new Qt(e,t);return this._sessions.set(i.id,i),this._activeSession=i,this.dispatchEvent("@@webxr-polyfill/vr-present-start",i.id),Promise.resolve(i.id)}).catch((...e)=>(console.error("session request failed: ",...e),Promise.reject()))}onBaseLayerSet(e,t){const r=this._sessions.get(e),i=t.context.canvas,s=r.baseLayer;if(r.baseLayer=t,r.immersive){if(null!==s){const e=s.context.canvas;this._wrapperDiv.removeChild(e),e.style.width=r.canvasWidth,e.style.height=r.canvasHeight,e.style.display=r.canvasDisplay,e.style.backgroundColor=r.canvasBackground}r.bodyBackgroundColor=document.body.style.backgroundColor,r.bodyBackgroundImage=document.body.style.backgroundImage,document.body.style.backgroundColor="transparent",document.body.style.backgroundImage="none";for(var n=document.body.children,a=0;a<n.length;a++){var o=n[a];if(!(o==this._wrapperDiv||o==i||this._domOverlayRoot&&this._domOverlayRoot.contains(o))){var h=o.style.display;o._displayChanged=!0,o._displayWas=h,o.style.display="none"}}r.canvasParent=i.parentNode,r.canvasNextSibling=i.nextSibling,r.canvasDisplay=i.style.display,i.style.display="block",r.canvasBackground=i.style.backgroundColor,i.style.backgroundColor="transparent",r.canvasWidth=i.style.width,r.canvasHeight=i.style.height,i.style.width="100%",i.style.height="100%",this._wrapperDiv.appendChild(i),this._wrapperDiv.style.display="block"}}userEndedSession(){if(this._activeSession){let e=this._activeSession;e.immersive&&!e.ended&&(this.endSession(e.id),this.dispatchEvent("@@webxr-polyfill/vr-present-end",e.id))}}endSession(e){const t=this._sessions.get(e);if(t&&!t.ended){if(t.ended=!0,this._activeSession===t){if(null!==t.baseLayer){for(var r=document.body.children,i=0;i<r.length;i++){var s=r[i];s!=this._wrapperDiv&&s._displayChanged&&(s.style.display=s._displayWas,s._displayWas="",s._displayChanged=!1)}const e=t.baseLayer.context.canvas;this._wrapperDiv.removeChild(e),t.canvasNextSibling?t.canvasNextSibling.before(e):t.canvasParent&&t.canvasParent.appendChild(e),t.canvasParent=null,t.canvasNextSibling=null,e.style.width=t.canvasWidth,e.style.height=t.canvasHeight,e.style.display=t.canvasDisplay,e.style.backgroundColor=t.canvasBackground,document.body.style.backgroundColor=t.bodyBackgroundColor,document.body.style.backgroundImage=t.bodyBackgroundImage}this._wrapperDiv.style.display="none",this._activeSession=null,Ve(this._headModelMatrix),this._arKitWrapper.stop(),this._domOverlayRoot=null,this._topMostDomElement=null,this._activeXRSession=null}this._frameSession=null}}requestAnimationFrame(e,...t){return this._arKitWrapper.requestAnimationFrame(e,t)}cancelAnimationFrame(e){return this._arKitWrapper.cancelAnimationFrame(e)}onFrameStart(e,t){const r=this._sessions.get(e);if(this._frameSession=r,r.immersive){if(Le(this._projectionMatrix,this._deviceProjectionMatrix),r.baseLayer){const e=r.baseLayer.context,t=e.getParameter(e.COLOR_CLEAR_VALUE),i=e.getParameter(e.DEPTH_CLEAR_VALUE),s=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1,0),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(t[0],t[1],t[2],t[3]),e.clearDepth(i),e.clearStencil(s)}}else if(r.baseLayer){const e=r.baseLayer.context.canvas;!function(e,t,r,i,s){let n,a=1/Math.tan(t/2);e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(n=1/(i-s),e[10]=(s+i)*n,e[14]=2*s*i*n):(e[10]=-1,e[14]=-2*i)}(this._projectionMatrix,t.inlineVerticalFieldOfView,e.width/e.height,t.depthNear,t.depthFar)}if(r.immersive)for(let e=0;e<this._gamepads.length;++e){const t=this._gamepads[e],i=this._gamepadInputSources[e];if(i.updateFromGamepad(t),i.targetRayMode="screen",-1!==i.primaryButtonIndex){const e=t.buttons[i.primaryButtonIndex].pressed;e&&!i.primaryActionPressed?this._gamepadInputSources[0]._active=!0:!e&&i.primaryActionPressed&&(this._shouldSuppressSelectEvents()||this.dispatchEvent("@@webxr-polyfill/input-select-end",{sessionId:r.id,inputSource:i.inputSource}),this._gamepadInputSources[0]._active=!1)}}this._runHitTest()}onFrameEnd(e){const t=this._sessions.get(e);if(t.immersive)for(let e=0;e<this._gamepads.length;++e){const r=this._gamepads[e],i=this._gamepadInputSources[e];if(-1!==i.primaryButtonIndex){const e=r.buttons[i.primaryButtonIndex].pressed;!e||i.primaryActionPressed||this._shouldSuppressSelectEvents()||this.dispatchEvent("@@webxr-polyfill/input-select-start",{sessionId:t.id,inputSource:i.inputSource}),i.primaryActionPressed=e}}this._frameSession=null}requestFrameOfReferenceTransform(e,t){return new Promise((t,r)=>{const i=e=>{this._baseFrameSet?e():this._frameOfRefRequestsWaiting.push(e)};switch(e){case"viewer":return void i(()=>{t(this._headModelMatrix)});case"local":return void i(()=>{t(this._eyeLevelMatrix)});case"local-floor":return void i(()=>{t(this._stageMatrix)});case"bounded-floor":case"unbounded":return void r(new Error("not supported "+e));default:return void r(new Error("Unsupported frame of reference type "+e))}})}getViewport(e,t,r,i){const{width:s,height:n}=r.context.canvas;return i.x=0,i.y=0,i.width=s,i.height=n,!0}getProjectionMatrix(e){return this._projectionMatrix}getBasePoseMatrix(){return this._frameSession.immersive?this._headModelMatrix:this._identityMatrix}getBaseViewMatrix(e){return this._frameSession.immersive?this._headModelMatrix:this._identityMatrix}requestStageBounds(){return null}getInputSources(){const e=[];for(const t of this._gamepadInputSources)t._active&&e.push(t.inputSource);return e}getInputPose(e,t,r){for(let i=0;i<this._gamepadInputSources.length;i++){const s=this._gamepadInputSources[i];if(s._active&&s.inputSource===e){const e=.5*(2*Math.atan(1/this._projectionMatrix[5])),n=this._projectionMatrix[14]/(this._projectionMatrix[10]-1),a=this._projectionMatrix[5]/this._projectionMatrix[0],o=document.documentElement.clientWidth,h=document.documentElement.clientHeight,l=this._touches[i].x/o*2-1,c=-this._touches[i].y/h*2+1,d=ke(De(),this._headModelMatrix);t._transformBasePoseMatrix(d,d);const u=Ve(De());We(u,u,-l*e*a),Ge(u,u,c*e),u[12]=l*Math.tan(e)*n*a,u[13]=c*Math.tan(e)*n,u[14]=-n,Xe(u,d,u);const p=this._gamepads[i].pose;He(p.position,u),qe(p.orientation,u);const m=s.getXRPose(t,r);return Ue(m.transform.matrix,p.orientation,p.position),ke(m.transform.inverse.matrix,m.transform.matrix),m}}return null}onWindowResize(){this._sessions.forEach((e,t)=>{})}}const Yt=(e,t,r,i)=>{const s=[];for(let e=0;e<r;e++)s.push({pressed:!1,touched:!1,value:0});return{id:e||"",pose:{hasPosition:i,position:new Float32Array([0,0,0]),orientation:new Float32Array([0,0,0,1])},buttons:s,hand:t,mapping:"xr-standard",axes:[0,0]}};let Kt=100;class Qt{constructor(e,t){this.mode=e,this.enabledFeatures=t,this.immersive="immersive-ar"==e,this.ended=null,this.baseLayer=null,this.id=++Kt}}class $t extends jt{constructor(e,t){super(e),this._arKitDevice=t}handleARKitUpdate(e){this._arKitDevice.setBaseViewMatrix(this._arKitWrapper._cameraTransform),this._arKitDevice.setProjectionMatrix(this._arKitWrapper._projectionMatrix)}handleOnError(...e){console.error("ARKit error",...e)}handleUserStoppedAR(e){this._arKitDevice.userEndedSession()}}const Zt=De();De();Ce.prototype._patchNavigatorXR=function(){this.xr=new U(Promise.resolve(new zt(this.global))),this.xr._mozillaXRViewer=!0,Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})};const Jt=navigator.userAgent.indexOf("Mobile/"),er=-1!==navigator.userAgent.indexOf("WebXRViewer")||(-1!==navigator.userAgent.indexOf("iPhone")||-1!==navigator.userAgent.indexOf("iPad"))&&-1!==Jt&&-1!==navigator.userAgent.indexOf("AppleWebKit")&&-1===navigator.userAgent.indexOf(" ",Jt)?new Ce(null,{webvr:!1,cardboard:!1}):null;let tr=null;const rr=()=>{void 0!==window.XRFrame&&(XRFrame.prototype.addAnchor=async function(e,t){if(!this.session[be].immersive)return Promise.reject();De();return e instanceof Float32Array?new Promise((r,i)=>{let s=this.session[be]._localSpace;Le(Zt,this.getPose(s,t).transform.matrix);const n=Xe(De(),Zt,e);tr.createAnchor(n).then(r).catch((...e)=>{console.error("could not create anchor",...e),i()})}):Promise.reject("invalid value passed to addAnchor "+e)},Qe.prototype.detach=async function(){return new Promise((e,t)=>{tr.removeAnchor(this),e()})})},ir=()=>{void 0!==window.XRSession&&(ye.prototype.requestHitTestSource=function(e={}){const t=new ct(this,e);return this[be].device.addHitTestSource(t),Promise.resolve(t)},ye.prototype.requestHitTestSourceForTransientInput=function(){throw new Error("requestHitTestSourceForTransientInput() is not supported yet.")},XRFrame.prototype.getHitTestResults=function(e){const t=this.session[be].device.getHitTestResults(e),r=[];for(const e of t)r.push(new it(this,e));return r},XRFrame.prototype.geetTransientInputHitTestResult=function(){throw new Error("geetTransientInputHitTestResult() is not supported yet.")})},sr=()=>{void 0!==window.XRFrame&&void 0!==window.XRSession&&(Object.defineProperty(XRFrame.prototype,"worldInformation",{get:function(){if(!this.session[be].immersive)throw new Error("Not implemented");return tr.getWorldInformation()}}),ye.prototype.updateWorldSensingState=function(e){if(!this[be].immersive)throw new Error("Not implemented");return tr.updateWorldSensingState(e)})},nr=()=>{void 0!==window.XRFrame&&(XRFrame.prototype.getGlobalLightEstimate=function(){if(!this.session[be].immersive)throw new Error("Not implemented");return tr.getLightProbe()},XRFrame.prototype.getGlobalReflectionProbe=function(){throw new Error("Not implemented")})},ar=()=>{void 0!==window.XRSession&&(ye.prototype.nonStandard_setNumberOfTrackedImages=function(e){if(!this[be].immersive)throw new Error("Not implemented");return tr.setNumberOfTrackedImages(e)},ye.prototype.nonStandard_createDetectionImage=function(e,t,r,i,s){if(!this[be].immersive)throw new Error("Not implemented");return tr.createDetectionImage(e,t,r,i,s)},ye.prototype.nonStandard_destroyDetectionImage=function(e){if(!this[be].immersive)throw new Error("Not implemented");return tr.createDetectionImage(e)},ye.prototype.nonStandard_activateDetectionImage=function(e){if(!this[be].immersive)throw new Error("Not implemented");return tr.activateDetectionImage(e)},ye.prototype.nonStandard_deactivateDetectionImage=function(e){if(!this[be].immersive)throw new Error("Not implemented");return tr.deactivateDetectionImage(e)},ye.prototype.nonStandard_getWorldMap=function(){if(!this[be].immersive)throw new Error("Not implemented");return tr.getWorldMap()},ye.prototype.nonStandard_setWorldMap=function(e){if(!this[be].immersive)throw new Error("Not implemented");return tr.setWorldMap(e)},ye.prototype.nonStandard_getWorldMappingStatus=function(){if(!this[be].immersive)throw new Error("Not implemented");return tr._worldMappingStatus})};if(er&&er.injected&&navigator.xr){tr=qt.GetOrCreate(),zt.initStyles(),window.XRSystem&&(U.prototype._isSessionSupported=U.prototype.isSessionSupported,U.prototype._requestSession=U.prototype.requestSession,U.prototype.isSessionSupported=function(e){return"immersive-ar"!==e&&"inline"!==e?Promise.resolve(!1):this._isSessionSupported(e)},U.prototype.requestSession=async function(e,t){if("immersive-ar"!==e&&"inline"!==e)throw new DOMException("Polyfill Error: only immersive-ar or inline mode is supported.");let r=await this._requestSession(e,t);if("immersive-ar"===e&&(r[be]._localSpace=await r.requestReferenceSpace("local")),t&&t.domOverlay&&t.domOverlay.root){r.domOverlayState={type:"screen"};const e=r[be].device;e.setDomOverlayRoot(t.domOverlay.root),e.setActiveXRSession(r)}return r}),rr(),ir(),sr(),nr(),ar();for(const e of Object.keys(vt))void 0!==window[e]?console.warn(`${e} already defined on global.`):window[e]=vt[e]}});
